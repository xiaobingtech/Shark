name: HarmonyOS Deploy on MacOS

on:
  push:
    tags:
      - 'v*'  # åªå¯¹ v å¼€å¤´çš„ tag è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    # runs-on: macos-latest  # ä½¿ç”¨ Mac ç¯å¢ƒ
    runs-on: self-hosted
    
    # ä¸º Release æ·»åŠ ç­–ç•¥
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release
      actions: read
      checks: read

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…å«ç­¾åæ–‡ä»¶å’Œ tag ä¿¡æ¯ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿æ‰€æœ‰æ–‡ä»¶
          ref: ${{ github.ref }}

      # 2. è·å– tag ä¿¡æ¯å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Setup Tag Information
        run: |
          # è·å– tag åç§°ï¼ˆå»æ‰ refs/tags/ å‰ç¼€ï¼‰
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # è®¾ç½® Release åç§°ï¼ˆä½¿ç”¨ tag åç§°ï¼‰
          echo "RELEASE_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # ä» tag åç§°æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "Tag: $TAG_NAME"
          echo "Version: $VERSION"
          echo "Release Name: $TAG_NAME"

      - name: Inject GitHub Run Id
        run: |
          RUN_ID=${{ github.run_id }}
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^  public static readonly GITHUB_RUN_ID: string = '.*';/  public static readonly GITHUB_RUN_ID: string = '$RUN_ID';/" common/src/main/ets/constant/CommonConstants.ets
          else
            sed -i "s/^  public static readonly GITHUB_RUN_ID: string = '.*';/  public static readonly GITHUB_RUN_ID: string = '$RUN_ID';/" common/src/main/ets/constant/CommonConstants.ets
          fi

      # 3. è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Set Environment Variables
        run: |
          echo "COMMANDLINE_TOOL_DIR=/opt" >> $GITHUB_ENV
          echo "PROJECT_PATH=${{ github.workspace }}" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=${{ secrets.SIGNING_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          
          # è®¾ç½® DevEco SDK è·¯å¾„
          echo "DEVECO_SDK_HOME=/opt/command-line-tools/sdk" >> $GITHUB_ENV


      # 4. å®‰è£… JDK 17
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 5. ä¸‹è½½å¹¶åˆå¹¶å‘½ä»¤è¡Œå·¥å…·åˆ†å·åŒ…ï¼ˆmacOS runner è‡ªåŠ¨å®‰è£…ï¼‰
      - name: Download Commandline Tools (Split Archives) [macOS]
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail

          # macOS ä¾èµ–
          if ! command -v 7z >/dev/null 2>&1; then
            brew update
            brew install p7zip
          fi
          if ! command -v unzip >/dev/null 2>&1; then
            brew install unzip
          fi

          mkdir -p /tmp/cli-tools
          cd /tmp/cli-tools

          OWNER="xiaobingtech"
          REPO="commandline-tools-mac-arm64-6.0.2.640"
          BRANCH="main"

          # ä¸¤ç§ä¸‹è½½æºï¼šrawï¼ˆå®¹æ˜“è¢«å†…ç½‘æ‹¦ï¼‰ + github.comï¼ˆé€šå¸¸å¯ç”¨ï¼‰
          BASE_RAW="https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}"
          BASE_GH="https://github.com/${OWNER}/${REPO}/raw/${BRANCH}"

          download_one () {
            local filename="$1"
            local url_raw="${BASE_RAW}/${filename}"
            local url_gh="${BASE_GH}/${filename}"

            echo "ä¸‹è½½: ${filename}"
            echo "  - å°è¯• RAW: ${url_raw}"

            # å…ˆè¯• rawï¼Œæ‹¿åˆ° http code ä¾¿äºå®šä½
            http_code=$(curl -L -sS -o "${filename}" -w "%{http_code}" --retry 3 --retry-delay 2 --connect-timeout 30 "${url_raw}" || true)
            if [ "${http_code}" = "200" ]; then
              echo "  âœ… RAW æˆåŠŸ"
              return 0
            fi

            echo "  âš ï¸ RAW å¤±è´¥(http ${http_code})ï¼Œæ”¹ç”¨ github.com"
            rm -f "${filename}"

            http_code=$(curl -L -sS -o "${filename}" -w "%{http_code}" --retry 5 --retry-delay 2 --connect-timeout 30 "${url_gh}" || true)
            if [ "${http_code}" != "200" ]; then
              echo "  âŒ github.com ä¹Ÿå¤±è´¥(http ${http_code})"
              echo "  è¯·æ£€æŸ¥ self-hosted çš„ç½‘ç»œæ˜¯å¦å¯è®¿é—® github.com / æ˜¯å¦æœ‰ä»£ç†é‡å†™"
              exit 1
            fi
            echo "  âœ… github.com æˆåŠŸ"
          }

          echo "å¼€å§‹ä¸‹è½½å‘½ä»¤è¡Œå·¥å…·åˆ†å·åŒ…..."
          for i in {001..017}; do
            FILENAME="commandline-tools-mac-arm64-6.0.2.640.7z.${i}"
            download_one "${FILENAME}"
            echo "  æ–‡ä»¶å¤§å°: $(du -h "${FILENAME}" | cut -f1)"
          done

          echo "æ‰€æœ‰åˆ†å·ä¸‹è½½å®Œæˆ"
          ls -lh *.7z.*

          FILE_COUNT=$(ls -1 *.7z.* 2>/dev/null | wc -l | tr -d ' ')
          if [ "$FILE_COUNT" -ne 17 ]; then
            echo "âŒ é”™è¯¯: æœŸæœ› 17 ä¸ªåˆ†å·æ–‡ä»¶ï¼Œä½†æ‰¾åˆ° $FILE_COUNT ä¸ª"
            exit 1
          fi

          echo "åˆå¹¶åˆ†å·..."
          COMBINED_FILE="commandline-tools-mac-arm64-6.0.2.640.7z"
          cat commandline-tools-mac-arm64-6.0.2.640.7z.* > "$COMBINED_FILE"
          echo "âœ… åˆå¹¶æˆåŠŸ: $COMBINED_FILE ($(du -h "$COMBINED_FILE" | cut -f1))"

          sudo mkdir -p /opt/command-line-tools
          sudo chown -R "$(whoami)":staff /opt/command-line-tools || true

          echo "è§£å‹ 7z..."
          mkdir -p extract
          7z x "$COMBINED_FILE" -oextract -y

          ZIP_FILE=$(find extract -name "*.zip" -type f | head -1 || true)
          if [ -n "${ZIP_FILE:-}" ]; then
            unzip -q "$ZIP_FILE" -d /opt/command-line-tools
          else
            rsync -a extract/ /opt/command-line-tools/
          fi

          if [ -d "/opt/command-line-tools/command-line-tools" ]; then
            sudo rsync -a /opt/command-line-tools/command-line-tools/ /opt/command-line-tools/
            sudo rm -rf /opt/command-line-tools/command-line-tools
          fi

          sudo chmod -R 755 /opt/command-line-tools

          cd /
          rm -rf /tmp/cli-tools
          echo "âœ… å‘½ä»¤è¡Œå·¥å…·å®‰è£…å®Œæˆ"


      # 6. æ ¹æ®å®é™…ä½ç½®é…ç½®ç¯å¢ƒå˜é‡
      - name: Configure Environment
        run: |
          # æŸ¥æ‰¾å·¥å…·çš„å®é™…ä½ç½®
          HVIGORW_PATH=$(find /opt -name "hvigorw" -type f 2>/dev/null | head -1)
          OHPM_PATH=$(find /opt -name "ohpm" -type f 2>/dev/null | head -1)
          HDC_PATH=$(find /opt -name "hdc" -type f 2>/dev/null | head -1)
          
          # æå–ç›®å½•è·¯å¾„å¹¶æ·»åŠ åˆ° PATH
          if [ -n "$HVIGORW_PATH" ]; then
            HVIGORW_DIR=$(dirname "$HVIGORW_PATH")
            echo "$HVIGORW_DIR" >> $GITHUB_PATH
          fi
          
          if [ -n "$OHPM_PATH" ]; then
            OHPM_DIR=$(dirname "$OHPM_PATH")
            echo "$OHPM_DIR" >> $GITHUB_PATH
          fi
          
          if [ -n "$HDC_PATH" ]; then
            HDC_DIR=$(dirname "$HDC_PATH")
            echo "$HDC_DIR" >> $GITHUB_PATH
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é€šç”¨çš„ bin ç›®å½•
          BIN_DIRS=$(find /opt/command-line-tools -name "bin" -type d 2>/dev/null)
          for dir in $BIN_DIRS; do
            echo "$dir" >> $GITHUB_PATH
          done
          
          # è®¾ç½® DEVECO_SDK_HOME åˆ° PATH
          echo "/opt/command-line-tools/sdk" >> $GITHUB_PATH

      # 7. åˆ›å»ºç¬¦å·é“¾æ¥
      - name: Create Symbolic Links
        run: |
          # ä¸ºå·¥å…·åˆ›å»ºç¬¦å·é“¾æ¥åˆ° /usr/local/bin
          for tool in hvigorw ohpm hdc; do
            TOOL_PATH=$(find /opt -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$TOOL_PATH" ]; then
              sudo ln -sf "$TOOL_PATH" /usr/local/bin/
            fi
          done

      # 8. é…ç½® npm å’Œ ohpm é•œåƒ
      - name: Configure Registries
        run: |
          npm config set registry https://repo.huaweicloud.com/repository/npm/
          npm config set "@ohos:registry" https://repo.harmonyos.com/npm/
          
          if command -v ohpm &> /dev/null; then
            ohpm config set registry https://ohpm.openharmony.cn/ohpm/
            ohpm config set strict_ssl false
          fi

      # 9. å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install System Dependencies [Linux only]
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev

      # 10. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install Dependencies
        run: |
          cd ${{ env.PROJECT_PATH }}
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡
          export DEVECO_SDK_HOME=/opt/command-line-tools/sdk
          
          # å®‰è£… npm ä¾èµ–
          if [ -f "package.json" ]; then
            npm install
          fi
          
          # å®‰è£… ohpm ä¾èµ–
          if [ -f "oh-package.json5" ] || [ -f "oh-package.json" ]; then
            if command -v ohpm &> /dev/null; then
              ohpm install --all
            fi
          fi

      # 11. æ„å»º release APP
      - name: Build Release APP
        run: |
          cd ${{ env.PROJECT_PATH }}
          echo "å¼€å§‹æ„å»º release APP..."
          echo "ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "Tag: ${{ env.TAG_NAME }}"
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡å·²è®¾ç½®
          export DEVECO_SDK_HOME=/opt/command-line-tools/sdk
          
          # å…ˆæ¸…ç†
          hvigorw clean --no-daemon
          
          # æ„å»º APP
          hvigorw assembleApp --mode project -p product=default --no-daemon
          echo "Release APP æ„å»ºå®Œæˆ"
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          echo "=== æ„å»ºäº§ç‰© ==="
          find . -name "*.app" -type f 2>/dev/null
          find . -name "*.hap" -type f 2>/dev/null

      # 12. ç­¾å release APP
      - name: Sign Release APP
        run: |
          cd ${{ env.PROJECT_PATH }}
          
          echo "å¼€å§‹ç­¾å release APP..."
          
          # æŸ¥æ‰¾æœªç­¾åçš„ APP æ–‡ä»¶ï¼ˆ.app æ–‡ä»¶ï¼‰
          UNSIGNED_APP=$(find . -name "*release-unsigned.app" -type f | head -1)
          if [ -z "$UNSIGNED_APP" ]; then
            echo "æœªæ‰¾åˆ° release æœªç­¾åçš„ APP æ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–..."
            UNSIGNED_APP=$(find . -name "*-unsigned.app" -type f | head -1)
          fi
          
          # å¦‚æœæ‰¾ä¸åˆ°æœªç­¾åçš„ APPï¼Œå°è¯•æŸ¥æ‰¾æœªç­¾åçš„ HAP
          if [ -z "$UNSIGNED_APP" ]; then
            echo "æœªæ‰¾åˆ°æœªç­¾åçš„ APP æ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾æœªç­¾åçš„ HAP æ–‡ä»¶..."
            UNSIGNED_HAP=$(find . -name "*release-unsigned.hap" -type f | head -1)
            if [ -z "$UNSIGNED_HAP" ]; then
              UNSIGNED_HAP=$(find . -name "*-unsigned.hap" -type f | head -1)
            fi
            
            if [ -n "$UNSIGNED_HAP" ]; then
              echo "æ‰¾åˆ°æœªç­¾åçš„ HAP: $UNSIGNED_HAP"
              UNSIGNED_APP="$UNSIGNED_HAP"
            fi
          fi
          
          if [ -z "$UNSIGNED_APP" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•æœªç­¾åçš„æ„å»ºäº§ç‰©"
            echo "æœç´¢åˆ°çš„æ–‡ä»¶:"
            find . -name "*.app" -type f 2>/dev/null
            find . -name "*.hap" -type f 2>/dev/null
            exit 1
          fi
          
          if [[ "$UNSIGNED_APP" == *.app ]]; then
            EXTENSION=".app"
            BASENAME=$(basename "$UNSIGNED_APP" "-unsigned.app")
            OUTPUT_EXTENSION=".app"
          else
            EXTENSION=".hap"
            BASENAME=$(basename "$UNSIGNED_APP" "-unsigned.hap")
            OUTPUT_EXTENSION=".hap"
          fi
          
          # ç”Ÿæˆç­¾ååçš„æ–‡ä»¶åï¼ˆæ·»åŠ ç‰ˆæœ¬å·ï¼‰
          SIGNED_FILE="build/${BASENAME}-v${{ env.VERSION }}-signed${OUTPUT_EXTENSION}"
          
          # ç¡®ä¿ build ç›®å½•å­˜åœ¨
          mkdir -p build
          
          # æŸ¥æ‰¾ç­¾åå·¥å…·
          SIGN_TOOL=$(find /opt -name "hap-sign-tool.jar" -type f 2>/dev/null | head -1)
          
          echo "ä½¿ç”¨ç­¾åå·¥å…·: $SIGN_TOOL"
          echo "è¾“å…¥æ–‡ä»¶: $UNSIGNED_APP"
          echo "è¾“å‡ºæ–‡ä»¶: $SIGNED_FILE"
          echo "æ–‡ä»¶ç±»å‹: ${EXTENSION:1}"  # å»æ‰ç‚¹çš„æ‰©å±•å
          
          # æ‰§è¡Œç­¾å
          java -jar "$SIGN_TOOL" \
            sign-app \
            -keyAlias "${{ env.SIGNING_KEY_ALIAS }}" \
            -signAlg "SHA256withECDSA" \
            -mode "localSign" \
            -appCertFile "./dis.cer" \
            -profileFile "./disRelease.p7b" \
            -inFile "$UNSIGNED_APP" \
            -keystoreFile "./dis.p12" \
            -outFile "$SIGNED_FILE" \
            -keyPwd "${{ env.KEYSTORE_PASSWORD }}" \
            -keystorePwd "${{ env.KEYSTORE_PASSWORD }}"
          
          if [ -f "$SIGNED_FILE" ]; then
            echo "ç­¾åæˆåŠŸ: $SIGNED_FILE ($(du -h "$SIGNED_FILE" | cut -f1))"
          else
            echo "é”™è¯¯ï¼šç­¾åå¤±è´¥"
            exit 1
          fi

      # 13. å¤„ç†æ„å»ºäº§ç‰©ä»¥ä¾¿ä¸Šä¼ åˆ° GitHub Release
      - name: Prepare Artifacts for Release
        run: |
          cd ${{ env.PROJECT_PATH }}
          echo "=== å¤„ç†æ„å»ºäº§ç‰©ä»¥ä¾¿ä¸Šä¼ åˆ° GitHub Release ==="
          
          # æŸ¥æ‰¾æ‰€æœ‰ç­¾åæ–‡ä»¶ï¼ˆAPP å’Œ HAPï¼‰
          echo "æœç´¢ç­¾åæ–‡ä»¶..."
          SIGNED_APP=$(find . -name "*-v${{ env.VERSION }}-signed.app" -type f 2>/dev/null | head -1)
          SIGNED_HAP=$(find . -name "*-v${{ env.VERSION }}-signed.hap" -type f 2>/dev/null | head -1)
          
          # ä¼˜å…ˆä½¿ç”¨ APP æ–‡ä»¶
          if [ -n "$SIGNED_APP" ]; then
            PRIMARY_FILE="$SIGNED_APP"
            ORIGINAL_EXTENSION=".app"
            echo "æ‰¾åˆ° APP æ–‡ä»¶: $PRIMARY_FILE"
          elif [ -n "$SIGNED_HAP" ]; then
            PRIMARY_FILE="$SIGNED_HAP"
            ORIGINAL_EXTENSION=".hap"
            echo "æ‰¾åˆ° HAP æ–‡ä»¶: $PRIMARY_FILE"
          else
            # å¦‚æœæ²¡æœ‰å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç­¾åæ–‡ä»¶
            PRIMARY_FILE=$(find . -name "*-signed.app" -type f 2>/dev/null | head -1)
            if [ -n "$PRIMARY_FILE" ]; then
              ORIGINAL_EXTENSION=".app"
            else
              PRIMARY_FILE=$(find . -name "*-signed.hap" -type f 2>/dev/null | head -1)
              ORIGINAL_EXTENSION=".hap"
            fi
          fi
          
          if [ -z "$PRIMARY_FILE" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å·²ç­¾åçš„æ„å»ºäº§ç‰©"
            exit 1
          fi
          
          echo "åŸå§‹æ–‡ä»¶: $PRIMARY_FILE"
          
          # è·å–åŸå§‹æ–‡ä»¶åï¼ˆä¸å¸¦è·¯å¾„ï¼‰
          ORIGINAL_FILENAME=$(basename "$PRIMARY_FILE")
          
          # åä¸º AppGallery ä¸Šä¼ ä½¿ç”¨åŸå§‹æ–‡ä»¶ï¼ˆ.app æˆ– .hapï¼‰
          HUAWEI_UPLOAD_FILE="./$ORIGINAL_FILENAME"
          cp "$PRIMARY_FILE" "$HUAWEI_UPLOAD_FILE"
          echo "åä¸ºä¸Šä¼ æ–‡ä»¶: $HUAWEI_UPLOAD_FILE"
          
          # åˆ›å»ºæ–°çš„æ–‡ä»¶åç”¨äº GitHub Releaseï¼ˆå°† .app æ”¹ä¸º .zipï¼Œ.hap ä¿æŒä¸å˜ï¼‰
          if [[ "$ORIGINAL_EXTENSION" == ".app" ]]; then
            # å¯¹äº .app æ–‡ä»¶ï¼Œæ”¹ä¸º .zip æ‰©å±•åä»¥ä¾¿ GitHub æ¥å—
            UPLOAD_FILENAME="${ORIGINAL_FILENAME%.app}.zip"
            UPLOAD_EXTENSION=".zip"
            FILE_TYPE="app"
          else
            # å¯¹äº .hap æ–‡ä»¶ï¼Œä¿æŒåŸæ ·
            UPLOAD_FILENAME="$ORIGINAL_FILENAME"
            UPLOAD_EXTENSION=".hap"
            FILE_TYPE="hap"
          fi
          
          # å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼Œå¹¶æ ¹æ®éœ€è¦é‡å‘½å
          if [[ "$ORIGINAL_EXTENSION" == ".app" ]]; then
            # å¯¹äº .app æ–‡ä»¶ï¼Œåˆ›å»º zip æ–‡ä»¶
            echo "åˆ›å»º ZIP æ–‡ä»¶ä»¥ä¾¿ä¸Šä¼ åˆ° GitHub Release..."
            zip -j "./$UPLOAD_FILENAME" "$PRIMARY_FILE"
            FINAL_FILE_PATH="./$UPLOAD_FILENAME"
          else
            # å¯¹äº .hap æ–‡ä»¶ï¼Œç›´æ¥å¤åˆ¶
            cp "$PRIMARY_FILE" "./$UPLOAD_FILENAME"
            FINAL_FILE_PATH="./$UPLOAD_FILENAME"
          fi
          
          echo "æœ€ç»ˆä¸Šä¼ æ–‡ä»¶: $FINAL_FILE_PATH"
          echo "ä¸Šä¼ æ–‡ä»¶å: $UPLOAD_FILENAME"
          echo "åŸå§‹ç±»å‹: ${ORIGINAL_EXTENSION:1}"
          echo "ä¸Šä¼ ç±»å‹: ${UPLOAD_EXTENSION:1}"
          
          # å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "ARTIFACT_FILE=$FINAL_FILE_PATH" >> $GITHUB_ENV
          echo "ARTIFACT_FILENAME=$UPLOAD_FILENAME" >> $GITHUB_ENV
          echo "ORIGINAL_FILENAME=$ORIGINAL_FILENAME" >> $GITHUB_ENV
          echo "FILE_TYPE=$FILE_TYPE" >> $GITHUB_ENV
          echo "ORIGINAL_EXTENSION=$ORIGINAL_EXTENSION" >> $GITHUB_ENV
          # åä¸ºä¸Šä¼ ä½¿ç”¨åŸå§‹æ ¼å¼çš„æ–‡ä»¶
          echo "HUAWEI_UPLOAD_FILE=$HUAWEI_UPLOAD_FILE" >> $GITHUB_ENV
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ -f "$FINAL_FILE_PATH" ]; then
            size=$(du -h "$FINAL_FILE_PATH" | cut -f1)
            echo "âœ… å‡†å¤‡ä¸Šä¼ : $UPLOAD_FILENAME (${UPLOAD_EXTENSION:1}, $size)"
            
            # å¦‚æœæ˜¯ ZIP æ–‡ä»¶ï¼Œæ˜¾ç¤ºå†…å®¹ä¿¡æ¯
            if [[ "$UPLOAD_EXTENSION" == ".zip" ]]; then
              echo "ZIP æ–‡ä»¶å†…å®¹:"
              unzip -l "$FINAL_FILE_PATH" | head -5
            fi
          else
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨: $FINAL_FILE_PATH"
            exit 1
          fi

      - name: Upload to Huawei AppGallery
        env:
          HUAWEI_CLIENT_ID: ${{ secrets.HUAWEI_CLIENT_ID }}
          HUAWEI_CLIENT_SECRET: ${{ secrets.HUAWEI_CLIENT_SECRET }}
          HUAWEI_APP_ID: ${{ secrets.HUAWEI_APP_ID }}
          HUAWEI_RELEASE_TYPE: ${{ secrets.HUAWEI_RELEASE_TYPE || '1' }}
          HUAWEI_CHINA_MAINLAND_FLAG: ${{ secrets.HUAWEI_CHINA_MAINLAND_FLAG || '1' }}
          HUAWEI_UPLOAD_FILE: ${{ env.HUAWEI_UPLOAD_FILE }}
          ORIGINAL_FILENAME: ${{ env.ORIGINAL_FILENAME }}
        run: |
          set -euo pipefail

          FILE_PATH="${HUAWEI_UPLOAD_FILE:-}"
          FILE_NAME="${ORIGINAL_FILENAME:-}"

          if [ -z "${HUAWEI_CLIENT_ID:-}" ] || [ -z "${HUAWEI_CLIENT_SECRET:-}" ] || [ -z "${HUAWEI_APP_ID:-}" ]; then
            echo "âŒ ç¼ºå°‘åä¸ºä¸Šä¼ æ‰€éœ€å¯†é’¥"
            exit 1
          fi

          if [ -z "$FILE_PATH" ] || [ ! -f "$FILE_PATH" ]; then
            echo "âŒ ä¸Šä¼ æ–‡ä»¶ä¸å­˜åœ¨: $FILE_PATH"
            exit 1
          fi

          # æ¸…ç†éšè—æ¢è¡Œï¼Œé¿å… header/query å‚æ•°æ±¡æŸ“å¯¼è‡´ 403
          HUAWEI_CLIENT_ID="$(echo -n "$HUAWEI_CLIENT_ID" | tr -d '[:space:]')"
          HUAWEI_CLIENT_SECRET="$(echo -n "$HUAWEI_CLIENT_SECRET" | tr -d '\r\n')"
          HUAWEI_APP_ID="$(echo -n "$HUAWEI_APP_ID" | tr -d '[:space:]')"
          HUAWEI_RELEASE_TYPE="$(echo -n "${HUAWEI_RELEASE_TYPE:-1}" | tr -d '\r\n')"
          HUAWEI_CHINA_MAINLAND_FLAG="$(echo -n "${HUAWEI_CHINA_MAINLAND_FLAG:-1}" | tr -d '\r\n')"

          FILE_NAME="$(basename "$FILE_NAME" | tr -d '\r\n')"
          [ -z "$FILE_NAME" ] && FILE_NAME="$(basename "$FILE_PATH")"

          FILE_SIZE=$(wc -c < "$FILE_PATH" | tr -d ' ')
          SHA256=$(sha256sum "$FILE_PATH" | awk '{print $1}')
          echo "ğŸ“¦ å¾…ä¸Šä¼ : $FILE_NAME ($(du -h "$FILE_PATH" | cut -f1), SHA256: ${SHA256:0:16}...)"

          # â”€â”€ Step 1: è·å– Access Token â”€â”€
          echo "ğŸ“¤ è·å– Access Token..."
          TOKEN_RESP=$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"${HUAWEI_CLIENT_ID}\",\"client_secret\":\"${HUAWEI_CLIENT_SECRET}\"}" \
            "https://connect-api.cloud.huawei.com/api/oauth2/v1/token")

          if ! echo "$TOKEN_RESP" | jq empty >/dev/null 2>&1; then
            echo "âŒ Token API è¿”å›é JSON å“åº”"
            echo "$TOKEN_RESP"
            exit 1
          fi

          ACCESS_TOKEN=$(echo "$TOKEN_RESP" | jq -r '.access_token // empty')
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ è·å– access_token å¤±è´¥"
            echo "$TOKEN_RESP" | jq .
            exit 1
          fi
          # å¿«é€Ÿæ ¡éªŒ token å½’å±æ˜¯å¦ä¸ client_id ä¸€è‡´ï¼Œæå‰å‘ç° secret é…ç½®é”™ä½
          TOKEN_SUB=$(echo "$ACCESS_TOKEN" | cut -d'.' -f2 | tr '_-' '/+' | awk '{l=length($0)%4; if(l==2)print $0"=="; else if(l==3)print $0"="; else print $0}' | base64 -d 2>/dev/null | jq -r '.sub // empty' 2>/dev/null || true)
          if [ -n "$TOKEN_SUB" ] && [ "$TOKEN_SUB" != "$HUAWEI_CLIENT_ID" ]; then
            echo "âŒ token ä¸ client_id ä¸ä¸€è‡´: token.sub=$TOKEN_SUB, client_id=$HUAWEI_CLIENT_ID"
            exit 1
          fi
          echo "ğŸ” client_idæŒ‡çº¹: $(echo -n "$HUAWEI_CLIENT_ID" | sha256sum | cut -c1-12), app_idæŒ‡çº¹: $(echo -n "$HUAWEI_APP_ID" | sha256sum | cut -c1-12)"
          echo "âœ… Access Token è·å–æˆåŠŸ"

          # â”€â”€ Step 2: è·å–ä¸Šä¼ åœ°å€ï¼ˆä¸¥æ ¼å¯¹é½æœ¬åœ°å¯ç”¨ curlï¼‰ â”€â”€
          echo "ğŸ“¤ è·å–ä¸Šä¼ åœ°å€..."
          HTTP_CODE=$(curl -sS -G \
            "https://connect-api.cloud.huawei.com/api/publish/v2/upload-url/for-obs" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Host: connect-api.cloud.huawei.com" \
            -H "client_id: ${HUAWEI_CLIENT_ID}" \
            --data-urlencode "appId=${HUAWEI_APP_ID}" \
            --data-urlencode "fileName=${FILE_NAME}" \
            --data-urlencode "contentLength=${FILE_SIZE}" \
            -D /tmp/huawei_upload_headers.txt \
            -o /tmp/huawei_upload_body.txt \
            -w "%{http_code}")

          RESP_BODY=$(cat /tmp/huawei_upload_body.txt)

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ è·å–ä¸Šä¼ åœ°å€å¤±è´¥ (HTTP $HTTP_CODE)"
            echo "----- response headers -----"
            sed -n '1,120p' /tmp/huawei_upload_headers.txt || true
            echo "----- response body -----"
            cat /tmp/huawei_upload_body.txt || true
            exit 1
          fi

          RET_CODE=$(echo "$RESP_BODY" | jq -r '.ret.code // empty')
          RET_MSG=$(echo "$RESP_BODY" | jq -r '.ret.msg // empty')
          if [ -n "$RET_CODE" ] && [ "$RET_CODE" != "0" ]; then
            echo "âŒ è·å–ä¸Šä¼ åœ°å€å¤±è´¥: ret.code=$RET_CODE, msg=$RET_MSG"
            exit 1
          fi

          UPLOAD_URL=$(echo "$RESP_BODY" | jq -r '.urlInfo.url // empty')
          UPLOAD_HDR_AUTH=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers.Authorization // empty')
          UPLOAD_HDR_SHA256=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."x-amz-content-sha256" // empty')
          UPLOAD_HDR_DATE=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."x-amz-date" // empty')
          UPLOAD_HDR_HOST=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers.Host // empty')
          UPLOAD_HDR_UA=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."user-agent" // empty')
          UPLOAD_HDR_CT=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."Content-Type" // "application/octet-stream"')

          if [ -z "$UPLOAD_URL" ]; then
            echo "âŒ è·å–ä¸Šä¼ åœ°å€å¤±è´¥: urlInfo.url ä¸ºç©º"
            echo "$RESP_BODY" | jq .
            exit 1
          fi
          echo "âœ… ä¸Šä¼ åœ°å€è·å–æˆåŠŸ"

          # â”€â”€ Step 3: ä¸Šä¼ æ–‡ä»¶ (PUT to OBS) â”€â”€
          echo "ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ°åä¸º OBS..."
          CURL_ARGS=(-sS -w "\n%{http_code}" -X PUT --upload-file "$FILE_PATH")
          [ -n "$UPLOAD_HDR_AUTH" ]   && CURL_ARGS+=(-H "Authorization: $UPLOAD_HDR_AUTH")
          [ -n "$UPLOAD_HDR_SHA256" ] && CURL_ARGS+=(-H "x-amz-content-sha256: $UPLOAD_HDR_SHA256")
          [ -n "$UPLOAD_HDR_DATE" ]   && CURL_ARGS+=(-H "x-amz-date: $UPLOAD_HDR_DATE")
          [ -n "$UPLOAD_HDR_HOST" ]   && CURL_ARGS+=(-H "Host: $UPLOAD_HDR_HOST")
          [ -n "$UPLOAD_HDR_UA" ]     && CURL_ARGS+=(-H "user-agent: $UPLOAD_HDR_UA")
          [ -n "$UPLOAD_HDR_CT" ]     && CURL_ARGS+=(-H "Content-Type: $UPLOAD_HDR_CT")

          UPLOAD_RESP=$(curl "${CURL_ARGS[@]}" "$UPLOAD_URL")
          UPLOAD_HTTP_CODE=$(echo "$UPLOAD_RESP" | tail -n1)
          UPLOAD_RESP_BODY=$(echo "$UPLOAD_RESP" | sed '$d')

          if [ "$UPLOAD_HTTP_CODE" = "200" ] || [ "$UPLOAD_HTTP_CODE" = "201" ] || [ "$UPLOAD_HTTP_CODE" = "204" ]; then
            echo "âœ… åä¸º AppGallery ä¸Šä¼ æˆåŠŸï¼($FILE_NAME, $(du -h "$FILE_PATH" | cut -f1))"
          else
            echo "âŒ ä¸Šä¼ å¤±è´¥ (HTTP $UPLOAD_HTTP_CODE)"
            echo "$UPLOAD_RESP_BODY"
            exit 1
          fi
      

      # 14. åˆ›å»º GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨ tag åç§°ä½œä¸º Release åç§°
          name: ${{ env.RELEASE_NAME }}
          
          # Release è¯´æ˜
          body: |
            # HarmonyOS åº”ç”¨å‘å¸ƒ - ${{ env.VERSION }}
            
            ## ğŸš€ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ env.VERSION }}
            - **Tag**: ${{ env.TAG_NAME }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            
            ## ğŸ“¦ æ„å»ºäº§ç‰©
            ä¸‹æ–¹æä¾›äº†å·²ç­¾åçš„ HarmonyOS åº”ç”¨æ–‡ä»¶ï¼Œå¯ç›´æ¥å®‰è£…åˆ° HarmonyOS è®¾å¤‡ã€‚
            
            ### æ–‡ä»¶ä¿¡æ¯
            - **ä¸‹è½½æ–‡ä»¶å**: ${{ env.ARTIFACT_FILENAME }}
            - **åŸå§‹ç±»å‹**: ${{ env.FILE_TYPE == 'app' && 'APP æ–‡ä»¶' || 'HAP æ–‡ä»¶' }}
            - **ä¸Šä¼ æ ¼å¼**: ${{ contains(env.ARTIFACT_FILENAME, '.zip') && 'ZIP å‹ç¼©åŒ…' || 'HAP æ–‡ä»¶' }}
            
            ## ğŸ“± å®‰è£…è¯´æ˜
            
            ### å¯¹äº APP æ–‡ä»¶ï¼ˆ.zip æ ¼å¼ï¼‰:
            1. ä¸‹è½½ **${{ env.ARTIFACT_FILENAME }}** æ–‡ä»¶
            2. è§£å‹ ZIP æ–‡ä»¶ï¼Œè·å– **${{ env.ORIGINAL_FILENAME }}**
            3. å°†è§£å‹åçš„æ–‡ä»¶ä¼ è¾“åˆ° HarmonyOS è®¾å¤‡
            4. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
            ```bash
            hdc install ${{ env.ORIGINAL_FILENAME }}
            ```
            
            ### å¯¹äº HAP æ–‡ä»¶:
            1. ä¸‹è½½ **${{ env.ARTIFACT_FILENAME }}** æ–‡ä»¶
            2. å°†æ–‡ä»¶ä¼ è¾“åˆ° HarmonyOS è®¾å¤‡
            3. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
            ```bash
            hdc install ${{ env.ARTIFACT_FILENAME }}
            ```
            
            4. æˆ–åœ¨è®¾å¤‡æ–‡ä»¶ç®¡ç†å™¨ä¸­ç›´æ¥ç‚¹å‡»å®‰è£…
            
            ## ğŸ”§ æ„å»ºä¿¡æ¯
            - æ„å»ºç³»ç»Ÿ: GitHub Actions
            - æ„å»ºç¯å¢ƒ: MacOS
            - HarmonyOS SDK: 6.0.2.640
            - æ„å»ºå·¥å…·: hvigorw assembleApp
            
            ---
            
            *æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          
          # ä½¿ç”¨ç°æœ‰çš„ tag
          tag_name: ${{ env.TAG_NAME }}
          
          # æ˜¯å¦ä¸ºè‰ç¨¿
          draft: false
          
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒ
          prerelease: ${{ contains(env.TAG_NAME, 'beta') || contains(env.TAG_NAME, 'alpha') || contains(env.TAG_NAME, 'rc') || contains(env.TAG_NAME, 'preview') }}
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          generate_release_notes: true
          
          # ä¸Šä¼ æ–‡ä»¶
          files: |
            ${{ env.ARTIFACT_FILE }}
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 15. æ„å»ºå®Œæˆé€šçŸ¥
      - name: Build Complete
        run: |
          echo "ğŸ‰ HarmonyOS åº”ç”¨æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
          echo "  - ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "  - Tag: ${{ env.TAG_NAME }}"
          echo "  - Release: ${{ steps.create_release.outputs.html_url }}"
          echo "  - æ„å»ºäº§ç‰©: ${{ env.ARTIFACT_FILENAME }}"
          echo "  - åŸå§‹æ–‡ä»¶: ${{ env.ORIGINAL_FILENAME }}"
          echo ""
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          if [ -f "${{ env.ARTIFACT_FILE }}" ]; then
            size=$(du -h "${{ env.ARTIFACT_FILE }}" | cut -f1)
            sha=$(sha256sum "${{ env.ARTIFACT_FILE }}" | cut -d' ' -f1)
            echo "ğŸ“¦ æ–‡ä»¶è¯¦æƒ…:"
            echo "  - ä¸Šä¼ æ–‡ä»¶å: ${{ env.ARTIFACT_FILENAME }}"
            echo "  - åŸå§‹æ–‡ä»¶å: ${{ env.ORIGINAL_FILENAME }}"
            echo "  - æ–‡ä»¶ç±»å‹: ${{ env.FILE_TYPE == 'app' && 'APP (æ‰“åŒ…ä¸ºZIP)' || 'HAP' }}"
            echo "  - å¤§å°: $size"
            echo "  - SHA256: $sha"
            
            # å¦‚æœæ˜¯ ZIP æ–‡ä»¶ï¼Œæ˜¾ç¤ºè§£å‹è¯´æ˜
            if [[ "${{ env.ARTIFACT_FILENAME }}" == *.zip ]]; then
              echo ""
              echo "ğŸ“ ä½¿ç”¨è¯´æ˜:"
              echo "  1. ä¸‹è½½ ${{ env.ARTIFACT_FILENAME }}"
              echo "  2. è§£å‹è·å– ${{ env.ORIGINAL_FILENAME }}"
              echo "  3. ä½¿ç”¨ hdc install ${{ env.ORIGINAL_FILENAME }} å®‰è£…"
            fi
          fi
