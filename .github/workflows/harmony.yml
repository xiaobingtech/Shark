name: HarmonyOS Release Build

on:
  push:
    tags:
      - 'v*'  # Âè™ÂØπ v ÂºÄÂ§¥ÁöÑ tag Ëß¶ÂèëÔºå‰æãÂ¶Ç v1.0.0
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë

jobs:
  build-and-release:
    runs-on: ubuntu-latest  # ‰ΩøÁî® Ubuntu Linux ÁéØÂ¢É
    
    # ‰∏∫ Release Ê∑ªÂä†Á≠ñÁï•
    permissions:
      contents: write  # ÈúÄË¶ÅÂÜôÂÖ•ÊùÉÈôêÊù•ÂàõÂª∫ Release
      actions: read
      checks: read

    steps:
      # 1. Ê£ÄÂá∫‰ª£Á†ÅÔºàÂåÖÂê´Á≠æÂêçÊñá‰ª∂Âíå tag ‰ø°ÊÅØÔºâ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤ÔºåÁ°Æ‰øùÊâÄÊúâÊñá‰ª∂
          ref: ${{ github.ref }}

      # 2. Ëé∑Âèñ tag ‰ø°ÊÅØÂπ∂ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
      - name: Setup Tag Information
        run: |
          # Ëé∑Âèñ tag ÂêçÁß∞ÔºàÂéªÊéâ refs/tags/ ÂâçÁºÄÔºâ
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # ËÆæÁΩÆ Release ÂêçÁß∞Ôºà‰ΩøÁî® tag ÂêçÁß∞Ôºâ
          echo "RELEASE_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # ‰ªé tag ÂêçÁß∞ÊèêÂèñÁâàÊú¨Âè∑ÔºàÂéªÊéâ v ÂâçÁºÄÔºâ
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "Tag: $TAG_NAME"
          echo "Version: $VERSION"
          echo "Release Name: $RELEASE_NAME"

      - name: Inject GitHub Run Id
        run: |
          RUN_ID=${{ github.run_id }}
          sed -i "s/^  public static readonly GITHUB_RUN_ID: string = '.*';/  public static readonly GITHUB_RUN_ID: string = '$RUN_ID';/" common/src/main/ets/constant/CommonConstants.ets

      # 3. ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè
      - name: Set Environment Variables
        run: |
          echo "JAVA_HOME=/opt/jdk-17" >> $GITHUB_ENV
          echo "COMMANDLINE_TOOL_DIR=/opt" >> $GITHUB_ENV
          echo "PROJECT_PATH=${{ github.workspace }}" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=${{ secrets.SIGNING_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          
          # ËÆæÁΩÆ DevEco SDK Ë∑ØÂæÑ
          echo "DEVECO_SDK_HOME=/opt/command-line-tools/sdk" >> $GITHUB_ENV

      # 4. ÂÆâË£Ö JDK 17
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 5. ‰∏ãËΩΩÂπ∂ÂêàÂπ∂ÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑ÂàÜÂç∑ÂåÖ
      - name: Download Commandline Tools (Split Archives)
        run: |
          # ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩï
          mkdir -p /tmp/cli-tools
          cd /tmp/cli-tools
          
          # ÂàÜÂç∑Êñá‰ª∂ÁöÑÂü∫Á°Ä URL
          BASE_URL="https://raw.githubusercontent.com/xiaobingtech/commandline-tools-linux-x64-6.0.2.640/refs/heads/main"
          
          echo "ÂºÄÂßã‰∏ãËΩΩÂëΩ‰ª§Ë°åÂ∑•ÂÖ∑ÂàÜÂç∑ÂåÖ..."
          
          # ‰∏ãËΩΩÊâÄÊúâÂàÜÂç∑Êñá‰ª∂Ôºà001 Âà∞ 019Ôºâ
          for i in {001..019}; do
            FILENAME="commandline-tools-linux-x64-6.0.2.640.7z.$i"
            URL="$BASE_URL/$FILENAME"
            echo "‰∏ãËΩΩ: $FILENAME"
            
            # ‰ΩøÁî®ÈáçËØïÊú∫Âà∂‰∏ãËΩΩ
            for attempt in {1..3}; do
              echo "‰∏ãËΩΩÂ∞ùËØï $attempt..."
              if wget -q --timeout=30 "$URL" -O "$FILENAME"; then
                echo "‚úÖ ‰∏ãËΩΩÊàêÂäü: $FILENAME ($(du -h "$FILENAME" | cut -f1))"
                break
              else
                echo "‚ùå ‰∏ãËΩΩÂ§±Ë¥• $attempt: $FILENAME"
                if [ $attempt -eq 3 ]; then
                  echo "‚ùå ‰∏ãËΩΩÂ§±Ë¥•: $FILENAMEÔºåÁªàÊ≠¢ÊûÑÂª∫"
                  exit 1
                fi
                sleep 3
              fi
            done
          done
          
          echo "ÊâÄÊúâÂàÜÂç∑‰∏ãËΩΩÂÆåÊàê"
          echo "Êñá‰ª∂ÂàóË°®:"
          ls -lh *.7z.*
          
          # È™åËØÅÊñá‰ª∂Êï∞Èáè
          FILE_COUNT=$(ls -1 *.7z.* 2>/dev/null | wc -l)
          echo "ÊâæÂà∞ $FILE_COUNT ‰∏™ÂàÜÂç∑Êñá‰ª∂"
          
          if [ "$FILE_COUNT" -ne 19 ]; then
            echo "‚ùå ÈîôËØØ: ÊúüÊúõ 19 ‰∏™ÂàÜÂç∑Êñá‰ª∂Ôºå‰ΩÜÊâæÂà∞ $FILE_COUNT ‰∏™"
            exit 1
          fi
          
          # ÂêàÂπ∂Êñá‰ª∂
          echo "ÂêàÂπ∂ÂàÜÂç∑Êñá‰ª∂..."
          COMBINED_FILE="commandline-tools-linux-x64-6.0.2.640.7z"
          cat commandline-tools-linux-x64-6.0.2.640.7z.* > "$COMBINED_FILE"
          
          # È™åËØÅÂêàÂπ∂ÂêéÁöÑÊñá‰ª∂
          if [ -f "$COMBINED_FILE" ]; then
            COMBINED_SIZE=$(du -h "$COMBINED_FILE" | cut -f1)
            echo "‚úÖ ÂêàÂπ∂ÊàêÂäü: $COMBINED_FILE ($COMBINED_SIZE)"
          else
            echo "‚ùå ÂêàÂπ∂Â§±Ë¥•"
            exit 1
          fi
          
          # ÂàõÂª∫ÁõÆÊ†áÁõÆÂΩï
          sudo mkdir -p /opt/command-line-tools
          sudo chown -R runner:runner /opt/command-line-tools
          
          echo "Ëß£Âéã 7z Êñá‰ª∂..."
          
          # ÂÆâË£ÖËß£ÂéãÂ∑•ÂÖ∑ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
          if ! command -v 7z &> /dev/null; then
            echo "ÂÆâË£Ö p7zip Â∑•ÂÖ∑..."
            sudo apt-get update
            sudo apt-get install -y p7zip-full
          fi
          
          if ! command -v unzip &> /dev/null; then
            echo "ÂÆâË£Ö unzip Â∑•ÂÖ∑..."
            sudo apt-get install -y unzip
          fi
          
          # ÂÖàÂàóÂá∫7zÊñá‰ª∂ÂÜÖÂÆπÔºåÊü•ÁúãÂÜÖÈÉ®ÁªìÊûÑ
          echo "ÂàóÂá∫7zÊñá‰ª∂ÂÜÖÂÆπ..."
          7z l "$COMBINED_FILE" | head -20
          
          # ÂàõÂª∫Ëß£ÂéãÁõÆÂΩï
          mkdir -p extract
          
          echo "Á¨¨‰∏ÄÊ≠•ÔºöËß£Âéã 7z Êñá‰ª∂..."
          # Ëß£Âéã7zÊñá‰ª∂
          7z x "$COMBINED_FILE" -oextract -y
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ 7z Ëß£ÂéãÊàêÂäü"
            
            # Êü•ÁúãËß£ÂéãÂá∫ÁöÑÊñá‰ª∂
            echo "Ëß£ÂéãÂá∫ÁöÑÊñá‰ª∂:"
            ls -la extract/
            
            # Êü•Êâæ zip Êñá‰ª∂
            ZIP_FILE=$(find extract -name "*.zip" -type f | head -1)
            if [ -n "$ZIP_FILE" ]; then
              echo "ÊâæÂà∞ ZIP Êñá‰ª∂: $ZIP_FILE"
              
              echo "Á¨¨‰∫åÊ≠•ÔºöËß£Âéã ZIP Êñá‰ª∂Âà∞ /opt/command-line-tools..."
              # Ëß£Âéã zip Êñá‰ª∂
              unzip "$ZIP_FILE" -d /opt/command-line-tools
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ ZIP Ëß£ÂéãÊàêÂäü"
                
                # Ê£ÄÊü•Ëß£ÂéãÁªìÊûú
                echo "Ê£ÄÊü•Ëß£ÂéãÁõÆÂΩïÂÜÖÂÆπ..."
                find /opt/command-line-tools -maxdepth 2 -type f | head -10
                
                # ËÆ°ÁÆóÊñá‰ª∂Êï∞Èáè
                FILE_COUNT=$(find /opt/command-line-tools -type f 2>/dev/null | wc -l)
                echo "Ëß£ÂéãÂá∫ $FILE_COUNT ‰∏™Êñá‰ª∂"
                
                # Ê£ÄÊü•ÂÖ≥ÈîÆÂ∑•ÂÖ∑
                echo "Êü•ÊâæÂÖ≥ÈîÆÂ∑•ÂÖ∑:"
                for tool in hvigorw ohpm hdc hap-sign-tool.jar; do
                  TOOL_PATH=$(find /opt/command-line-tools -name "$tool" -type f 2>/dev/null | head -1)
                  if [ -n "$TOOL_PATH" ]; then
                    echo "‚úÖ ÊâæÂà∞ $tool: $TOOL_PATH"
                  else
                    echo "‚ö†Ô∏è Êú™ÊâæÂà∞ $tool"
                  fi
                done
                
                # Ê£ÄÊü•ÊòØÂê¶ÊúâÂµåÂ•óÁöÑÁõÆÂΩïÁªìÊûÑÔºåÂ¶ÇÊûúÊúâÂàôË∞ÉÊï¥
                if [ -d "/opt/command-line-tools/command-line-tools" ]; then
                  echo "ÂèëÁé∞ÂµåÂ•óÁõÆÂΩïÁªìÊûÑÔºåÊ≠£Âú®Ë∞ÉÊï¥..."
                  mv /opt/command-line-tools/command-line-tools/* /opt/command-line-tools/
                  rm -rf /opt/command-line-tools/command-line-tools
                fi
                
              else
                echo "‚ùå ZIP Ëß£ÂéãÂ§±Ë¥•"
                exit 1
              fi
            else
              # Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ zip Êñá‰ª∂ÔºåÂ∞ùËØïÂÖ∂‰ªñÊ†ºÂºè
              echo "Êú™ÊâæÂà∞ ZIP Êñá‰ª∂ÔºåÊü•ÊâæÂÖ∂‰ªñÊ†ºÂºè..."
              ALL_FILES=$(find extract -type f)
              echo "ÊâÄÊúâËß£ÂéãÊñá‰ª∂:"
              echo "$ALL_FILES"
              
              # Â∞ùËØïÁõ¥Êé•ÁßªÂä®ÊâÄÊúâÊñá‰ª∂
              mv extract/* /opt/command-line-tools/ 2>/dev/null || true
              
              FILE_COUNT=$(find /opt/command-line-tools -type f 2>/dev/null | wc -l)
              echo "ÁßªÂä®‰∫Ü $FILE_COUNT ‰∏™Êñá‰ª∂Âà∞ /opt/command-line-tools"
            fi
          else
            echo "‚ùå 7z Ëß£ÂéãÂ§±Ë¥•"
            exit 1
          fi
          
          # ËÆæÁΩÆÁõÆÂΩïÊùÉÈôê
          sudo chmod -R 755 /opt/command-line-tools
          
          # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
          cd /
          rm -rf /tmp/cli-tools
          echo "‰∏¥Êó∂Êñá‰ª∂Ê∏ÖÁêÜÂÆåÊàê"

      # 6. Ê†πÊçÆÂÆûÈôÖ‰ΩçÁΩÆÈÖçÁΩÆÁéØÂ¢ÉÂèòÈáè
      - name: Configure Environment
        run: |
          # Êü•ÊâæÂ∑•ÂÖ∑ÁöÑÂÆûÈôÖ‰ΩçÁΩÆ
          HVIGORW_PATH=$(find /opt -name "hvigorw" -type f 2>/dev/null | head -1)
          OHPM_PATH=$(find /opt -name "ohpm" -type f 2>/dev/null | head -1)
          HDC_PATH=$(find /opt -name "hdc" -type f 2>/dev/null | head -1)
          
          # ÊèêÂèñÁõÆÂΩïË∑ØÂæÑÂπ∂Ê∑ªÂä†Âà∞ PATH
          if [ -n "$HVIGORW_PATH" ]; then
            HVIGORW_DIR=$(dirname "$HVIGORW_PATH")
            echo "$HVIGORW_DIR" >> $GITHUB_PATH
          fi
          
          if [ -n "$OHPM_PATH" ]; then
            OHPM_DIR=$(dirname "$OHPM_PATH")
            echo "$OHPM_DIR" >> $GITHUB_PATH
          fi
          
          if [ -n "$HDC_PATH" ]; then
            HDC_DIR=$(dirname "$HDC_PATH")
            echo "$HDC_DIR" >> $GITHUB_PATH
          fi
          
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄöÁî®ÁöÑ bin ÁõÆÂΩï
          BIN_DIRS=$(find /opt/command-line-tools -name "bin" -type d 2>/dev/null)
          for dir in $BIN_DIRS; do
            echo "$dir" >> $GITHUB_PATH
          done
          
          # ËÆæÁΩÆ DEVECO_SDK_HOME Âà∞ PATH
          echo "/opt/command-line-tools/sdk" >> $GITHUB_PATH

      # 7. ÂàõÂª∫Á¨¶Âè∑ÈìæÊé•
      - name: Create Symbolic Links
        run: |
          # ‰∏∫Â∑•ÂÖ∑ÂàõÂª∫Á¨¶Âè∑ÈìæÊé•Âà∞ /usr/local/bin
          for tool in hvigorw ohpm hdc; do
            TOOL_PATH=$(find /opt -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$TOOL_PATH" ]; then
              sudo ln -sf "$TOOL_PATH" /usr/local/bin/
            fi
          done

      # 8. ÈÖçÁΩÆ npm Âíå ohpm ÈïúÂÉè
      - name: Configure Registries
        run: |
          npm config set registry https://repo.huaweicloud.com/repository/npm/
          npm config set "@ohos:registry" https://repo.harmonyos.com/npm/
          
          if command -v ohpm &> /dev/null; then
            ohpm config set registry https://ohpm.openharmony.cn/ohpm/
            ohpm config set strict_ssl false
          fi

      # 9. ÂÆâË£ÖÁ≥ªÁªü‰æùËµñ
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev

      # 10. ÂÆâË£ÖÈ°πÁõÆ‰æùËµñ
      - name: Install Dependencies
        run: |
          cd ${{ env.PROJECT_PATH }}
          
          # Á°Æ‰øùÁéØÂ¢ÉÂèòÈáè
          export DEVECO_SDK_HOME=/opt/command-line-tools/sdk
          
          # ÂÆâË£Ö npm ‰æùËµñ
          if [ -f "package.json" ]; then
            npm install
          fi
          
          # ÂÆâË£Ö ohpm ‰æùËµñ
          if [ -f "oh-package.json5" ] || [ -f "oh-package.json" ]; then
            if command -v ohpm &> /dev/null; then
              ohpm install --all
            fi
          fi

      # 11. ÊûÑÂª∫ release APP
      - name: Build Release APP
        run: |
          cd ${{ env.PROJECT_PATH }}
          echo "ÂºÄÂßãÊûÑÂª∫ release APP..."
          echo "ÁâàÊú¨: ${{ env.VERSION }}"
          echo "Tag: ${{ env.TAG_NAME }}"
          
          # Á°Æ‰øùÁéØÂ¢ÉÂèòÈáèÂ∑≤ËÆæÁΩÆ
          export DEVECO_SDK_HOME=/opt/command-line-tools/sdk
          
          # ÂÖàÊ∏ÖÁêÜ
          hvigorw clean --no-daemon
          
          # ÊûÑÂª∫ APP
          hvigorw assembleApp --mode project -p product=default --no-daemon
          echo "Release APP ÊûÑÂª∫ÂÆåÊàê"
          
          # Ê£ÄÊü•ÊûÑÂª∫‰∫ßÁâ©
          echo "=== ÊûÑÂª∫‰∫ßÁâ© ==="
          find . -name "*.app" -type f 2>/dev/null
          find . -name "*.hap" -type f 2>/dev/null

      # 12. Á≠æÂêç release APP
      - name: Sign Release APP
        run: |
          cd ${{ env.PROJECT_PATH }}
          
          echo "ÂºÄÂßãÁ≠æÂêç release APP..."
          
          # Êü•ÊâæÊú™Á≠æÂêçÁöÑ APP Êñá‰ª∂Ôºà.app Êñá‰ª∂Ôºâ
          UNSIGNED_APP=$(find . -name "*release-unsigned.app" -type f | head -1)
          if [ -z "$UNSIGNED_APP" ]; then
            echo "Êú™ÊâæÂà∞ release Êú™Á≠æÂêçÁöÑ APP Êñá‰ª∂ÔºåÂ∞ùËØïÊü•ÊâæÂÖ∂‰ªñ..."
            UNSIGNED_APP=$(find . -name "*-unsigned.app" -type f | head -1)
          fi
          
          # Â¶ÇÊûúÊâæ‰∏çÂà∞Êú™Á≠æÂêçÁöÑ APPÔºåÂ∞ùËØïÊü•ÊâæÊú™Á≠æÂêçÁöÑ HAP
          if [ -z "$UNSIGNED_APP" ]; then
            echo "Êú™ÊâæÂà∞Êú™Á≠æÂêçÁöÑ APP Êñá‰ª∂ÔºåÂ∞ùËØïÊü•ÊâæÊú™Á≠æÂêçÁöÑ HAP Êñá‰ª∂..."
            UNSIGNED_HAP=$(find . -name "*release-unsigned.hap" -type f | head -1)
            if [ -z "$UNSIGNED_HAP" ]; then
              UNSIGNED_HAP=$(find . -name "*-unsigned.hap" -type f | head -1)
            fi
            
            if [ -n "$UNSIGNED_HAP" ]; then
              echo "ÊâæÂà∞Êú™Á≠æÂêçÁöÑ HAP: $UNSIGNED_HAP"
              UNSIGNED_APP="$UNSIGNED_HAP"
            fi
          fi
          
          if [ -z "$UNSIGNED_APP" ]; then
            echo "ÈîôËØØÔºöÊú™ÊâæÂà∞‰ªª‰ΩïÊú™Á≠æÂêçÁöÑÊûÑÂª∫‰∫ßÁâ©"
            echo "ÊêúÁ¥¢Âà∞ÁöÑÊñá‰ª∂:"
            find . -name "*.app" -type f 2>/dev/null
            find . -name "*.hap" -type f 2>/dev/null
            exit 1
          fi
          
          echo "ÊâæÂà∞Êú™Á≠æÂêçÁöÑÊñá‰ª∂: $UNSIGNED_APP"
          
          # Ê†πÊçÆÊñá‰ª∂Á±ªÂûãÁ°ÆÂÆöÊâ©Â±ïÂêç
          if [[ "$UNSIGNED_APP" == *.app ]]; then
            EXTENSION=".app"
            BASENAME=$(basename "$UNSIGNED_APP" "-unsigned.app")
            OUTPUT_EXTENSION=".app"
          else
            EXTENSION=".hap"
            BASENAME=$(basename "$UNSIGNED_APP" "-unsigned.hap")
            OUTPUT_EXTENSION=".hap"
          fi
          
          # ÁîüÊàêÁ≠æÂêçÂêéÁöÑÊñá‰ª∂ÂêçÔºàÊ∑ªÂä†ÁâàÊú¨Âè∑Ôºâ
          SIGNED_FILE="build/${BASENAME}-v${{ env.VERSION }}-signed${OUTPUT_EXTENSION}"
          
          # Á°Æ‰øù build ÁõÆÂΩïÂ≠òÂú®
          mkdir -p build
          
          # Êü•ÊâæÁ≠æÂêçÂ∑•ÂÖ∑
          SIGN_TOOL=$(find /opt -name "hap-sign-tool.jar" -type f 2>/dev/null | head -1)
          
          echo "‰ΩøÁî®Á≠æÂêçÂ∑•ÂÖ∑: $SIGN_TOOL"
          echo "ËæìÂÖ•Êñá‰ª∂: $UNSIGNED_APP"
          echo "ËæìÂá∫Êñá‰ª∂: $SIGNED_FILE"
          echo "Êñá‰ª∂Á±ªÂûã: ${EXTENSION:1}"  # ÂéªÊéâÁÇπÁöÑÊâ©Â±ïÂêç
          
          # ÊâßË°åÁ≠æÂêç
          java -jar "$SIGN_TOOL" \
            sign-app \
            -keyAlias "${{ env.SIGNING_KEY_ALIAS }}" \
            -signAlg "SHA256withECDSA" \
            -mode "localSign" \
            -appCertFile "./dis.cer" \
            -profileFile "./disRelease.p7b" \
            -inFile "$UNSIGNED_APP" \
            -keystoreFile "./dis.p12" \
            -outFile "$SIGNED_FILE" \
            -keyPwd "${{ env.KEYSTORE_PASSWORD }}" \
            -keystorePwd "${{ env.KEYSTORE_PASSWORD }}"
          
          if [ -f "$SIGNED_FILE" ]; then
            echo "Á≠æÂêçÊàêÂäü: $SIGNED_FILE ($(du -h "$SIGNED_FILE" | cut -f1))"
          else
            echo "ÈîôËØØÔºöÁ≠æÂêçÂ§±Ë¥•"
            exit 1
          fi

      # 13. Â§ÑÁêÜÊûÑÂª∫‰∫ßÁâ©‰ª•‰æø‰∏ä‰º†Âà∞ GitHub Release
      - name: Prepare Artifacts for Release
        run: |
          cd ${{ env.PROJECT_PATH }}
          echo "=== Â§ÑÁêÜÊûÑÂª∫‰∫ßÁâ©‰ª•‰æø‰∏ä‰º†Âà∞ GitHub Release ==="
          
          # Êü•ÊâæÊâÄÊúâÁ≠æÂêçÊñá‰ª∂ÔºàAPP Âíå HAPÔºâ
          echo "ÊêúÁ¥¢Á≠æÂêçÊñá‰ª∂..."
          SIGNED_APP=$(find . -name "*-v${{ env.VERSION }}-signed.app" -type f 2>/dev/null | head -1)
          SIGNED_HAP=$(find . -name "*-v${{ env.VERSION }}-signed.hap" -type f 2>/dev/null | head -1)
          
          # ‰ºòÂÖà‰ΩøÁî® APP Êñá‰ª∂
          if [ -n "$SIGNED_APP" ]; then
            PRIMARY_FILE="$SIGNED_APP"
            ORIGINAL_EXTENSION=".app"
            echo "ÊâæÂà∞ APP Êñá‰ª∂: $PRIMARY_FILE"
          elif [ -n "$SIGNED_HAP" ]; then
            PRIMARY_FILE="$SIGNED_HAP"
            ORIGINAL_EXTENSION=".hap"
            echo "ÊâæÂà∞ HAP Êñá‰ª∂: $PRIMARY_FILE"
          else
            # Â¶ÇÊûúÊ≤°ÊúâÂ∏¶ÁâàÊú¨Âè∑ÁöÑÊñá‰ª∂Ôºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊâæÂà∞ÁöÑÁ≠æÂêçÊñá‰ª∂
            PRIMARY_FILE=$(find . -name "*-signed.app" -type f 2>/dev/null | head -1)
            if [ -n "$PRIMARY_FILE" ]; then
              ORIGINAL_EXTENSION=".app"
            else
              PRIMARY_FILE=$(find . -name "*-signed.hap" -type f 2>/dev/null | head -1)
              ORIGINAL_EXTENSION=".hap"
            fi
          fi
          
          if [ -z "$PRIMARY_FILE" ]; then
            echo "ÈîôËØØÔºöÊú™ÊâæÂà∞Â∑≤Á≠æÂêçÁöÑÊûÑÂª∫‰∫ßÁâ©"
            exit 1
          fi
          
          echo "ÂéüÂßãÊñá‰ª∂: $PRIMARY_FILE"
          
          # Ëé∑ÂèñÂéüÂßãÊñá‰ª∂ÂêçÔºà‰∏çÂ∏¶Ë∑ØÂæÑÔºâ
          ORIGINAL_FILENAME=$(basename "$PRIMARY_FILE")
          
          # ÂàõÂª∫Êñ∞ÁöÑÊñá‰ª∂ÂêçÁî®‰∫é‰∏ä‰º†ÔºàÂ∞Ü .app Êîπ‰∏∫ .zipÔºå.hap ‰øùÊåÅ‰∏çÂèòÔºâ
          if [[ "$ORIGINAL_EXTENSION" == ".app" ]]; then
            # ÂØπ‰∫é .app Êñá‰ª∂ÔºåÊîπ‰∏∫ .zip Êâ©Â±ïÂêç‰ª•‰æø GitHub Êé•Âèó
            UPLOAD_FILENAME="${ORIGINAL_FILENAME%.app}.zip"
            UPLOAD_EXTENSION=".zip"
            FILE_TYPE="app"
          else
            # ÂØπ‰∫é .hap Êñá‰ª∂Ôºå‰øùÊåÅÂéüÊ†∑
            UPLOAD_FILENAME="$ORIGINAL_FILENAME"
            UPLOAD_EXTENSION=".hap"
            FILE_TYPE="hap"
          fi
          
          # Â§çÂà∂Êñá‰ª∂Âà∞Ê†πÁõÆÂΩïÔºåÂπ∂Ê†πÊçÆÈúÄË¶ÅÈáçÂëΩÂêç
          if [[ "$ORIGINAL_EXTENSION" == ".app" ]]; then
            # ÂØπ‰∫é .app Êñá‰ª∂ÔºåÂàõÂª∫ zip Êñá‰ª∂
            echo "ÂàõÂª∫ ZIP Êñá‰ª∂‰ª•‰æø‰∏ä‰º†..."
            zip -j "./$UPLOAD_FILENAME" "$PRIMARY_FILE"
            FINAL_FILE_PATH="./$UPLOAD_FILENAME"
          else
            # ÂØπ‰∫é .hap Êñá‰ª∂ÔºåÁõ¥Êé•Â§çÂà∂
            cp "$PRIMARY_FILE" "./$UPLOAD_FILENAME"
            FINAL_FILE_PATH="./$UPLOAD_FILENAME"
          fi
          
          echo "ÊúÄÁªà‰∏ä‰º†Êñá‰ª∂: $FINAL_FILE_PATH"
          echo "‰∏ä‰º†Êñá‰ª∂Âêç: $UPLOAD_FILENAME"
          echo "ÂéüÂßãÁ±ªÂûã: ${ORIGINAL_EXTENSION:1}"
          echo "‰∏ä‰º†Á±ªÂûã: ${UPLOAD_EXTENSION:1}"
          
          # Â∞ÜÊñá‰ª∂‰ø°ÊÅØ‰øùÂ≠òÂà∞ÁéØÂ¢ÉÂèòÈáè
          echo "ARTIFACT_FILE=$FINAL_FILE_PATH" >> $GITHUB_ENV
          echo "ARTIFACT_FILENAME=$UPLOAD_FILENAME" >> $GITHUB_ENV
          echo "ORIGINAL_FILENAME=$ORIGINAL_FILENAME" >> $GITHUB_ENV
          echo "FILE_TYPE=$FILE_TYPE" >> $GITHUB_ENV
          echo "ORIGINAL_EXTENSION=$ORIGINAL_EXTENSION" >> $GITHUB_ENV
          
          # È™åËØÅÊñá‰ª∂Â≠òÂú®
          if [ -f "$FINAL_FILE_PATH" ]; then
            size=$(du -h "$FINAL_FILE_PATH" | cut -f1)
            echo "‚úÖ ÂáÜÂ§á‰∏ä‰º†: $UPLOAD_FILENAME (${UPLOAD_EXTENSION:1}, $size)"
            
            # Â¶ÇÊûúÊòØ ZIP Êñá‰ª∂ÔºåÊòæÁ§∫ÂÜÖÂÆπ‰ø°ÊÅØ
            if [[ "$UPLOAD_EXTENSION" == ".zip" ]]; then
              echo "ZIP Êñá‰ª∂ÂÜÖÂÆπ:"
              unzip -l "$FINAL_FILE_PATH" | head -5
            fi
          else
            echo "‚ùå ÈîôËØØÔºöÊñá‰ª∂‰∏çÂ≠òÂú®: $FINAL_FILE_PATH"
            exit 1
          fi

      - name: Upload to Huawei AppGallery
        env:
          HUAWEI_CLIENT_ID: ${{ secrets.HUAWEI_CLIENT_ID }}
          HUAWEI_CLIENT_SECRET: ${{ secrets.HUAWEI_CLIENT_SECRET }}
          HUAWEI_APP_ID: ${{ secrets.HUAWEI_APP_ID }}
          HUAWEI_RELEASE_TYPE: ${{ secrets.HUAWEI_RELEASE_TYPE }}
          HUAWEI_CHINA_MAINLAND_FLAG: ${{ secrets.HUAWEI_CHINA_MAINLAND_FLAG }}
        run: |
          set -e
          FILE_PATH="${{ env.ARTIFACT_FILE }}"
          FILE_NAME="${{ env.ARTIFACT_FILENAME }}"
          if [ -z "$HUAWEI_CLIENT_ID" ] || [ -z "$HUAWEI_CLIENT_SECRET" ] || [ -z "$HUAWEI_APP_ID" ]; then
            echo "Áº∫Â∞ëÂçé‰∏∫‰∏ä‰º†ÊâÄÈúÄÂØÜÈí•"
            exit 1
          fi
          if [ ! -f "$FILE_PATH" ]; then
            echo "‰∏ä‰º†Êñá‰ª∂‰∏çÂ≠òÂú®: $FILE_PATH"
            exit 1
          fi
          FILE_SIZE=$(stat -c%s "$FILE_PATH")
          SHA256=$(sha256sum "$FILE_PATH" | cut -d' ' -f1)
          TOKEN_RESP=$(curl -sS -X POST -H "Content-Type: application/json" -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"${HUAWEI_CLIENT_ID}\",\"client_secret\":\"${HUAWEI_CLIENT_SECRET}\"}" https://connect-api.cloud.huawei.com/api/oauth2/v1/token)
          ACCESS_TOKEN=$(python3 -c "import json,sys;data=json.loads(sys.stdin.read());print(data.get('access_token',''))" <<< "$TOKEN_RESP")
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "Ëé∑Âèñ access_token Â§±Ë¥•"
            echo "$TOKEN_RESP"
            exit 1
          fi
          QUERY_ARGS=(
            --data-urlencode "appId=${HUAWEI_APP_ID}"
            --data-urlencode "fileName=${FILE_NAME}"
            --data-urlencode "contentLength=${FILE_SIZE}"
            --data-urlencode "sha256=${SHA256}"
          )
          if [ -n "$HUAWEI_RELEASE_TYPE" ]; then
            QUERY_ARGS+=(--data-urlencode "releaseType=${HUAWEI_RELEASE_TYPE}")
          fi
          if [ -n "$HUAWEI_CHINA_MAINLAND_FLAG" ]; then
            QUERY_ARGS+=(--data-urlencode "chineseMainlandFlag=${HUAWEI_CHINA_MAINLAND_FLAG}")
          fi
          UPLOAD_URL_RESP=$(curl -sS -G "https://connect-api.cloud.huawei.com/api/publish/v2/upload-url/for-obs" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "client_id: ${HUAWEI_CLIENT_ID}" \
            "${QUERY_ARGS[@]}")
          python3 -c "import json,sys;data=json.loads(sys.stdin.read());url_info=data.get('urlInfo') or {};url=url_info.get('url') or '';method=url_info.get('method') or 'PUT';headers=url_info.get('headers') or {};import sys as _s;if not url: print('NO_URL'); _s.exit(0);print(url); print(method); [sys.stdout.write('{}: {}\n'.format(k,v)) for k,v in headers.items()]" <<< "$UPLOAD_URL_RESP" > /tmp/huawei_upload_info.txt
          if [ "$(head -n 1 /tmp/huawei_upload_info.txt)" = "NO_URL" ]; then
            echo "Ëé∑Âèñ‰∏ä‰º†Âú∞ÂùÄÂ§±Ë¥•"
            exit 1
          fi
          UPLOAD_URL=$(sed -n '1p' /tmp/huawei_upload_info.txt)
          UPLOAD_METHOD=$(sed -n '2p' /tmp/huawei_upload_info.txt)
          tail -n +3 /tmp/huawei_upload_info.txt > /tmp/huawei_upload_headers.txt
          CURL_HEADERS=()
          while IFS= read -r header; do
            if [ -n "$header" ]; then
              CURL_HEADERS+=(-H "$header")
            fi
          done < /tmp/huawei_upload_headers.txt
          HTTP_CODE=$(curl -sS -o /tmp/huawei_upload_resp.txt -w "%{http_code}" -X "$UPLOAD_METHOD" "${CURL_HEADERS[@]}" --upload-file "$FILE_PATH" "$UPLOAD_URL")
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "‰∏ä‰º†Â§±Ë¥•ÔºåHTTP Áä∂ÊÄÅÁ†Å: $HTTP_CODE"
            cat /tmp/huawei_upload_resp.txt
            exit 1
          fi

      # 14. ÂàõÂª∫ GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          # ‰ΩøÁî® tag ÂêçÁß∞‰Ωú‰∏∫ Release ÂêçÁß∞
          name: ${{ env.RELEASE_NAME }}
          
          # Release ËØ¥Êòé
          body: |
            # HarmonyOS Â∫îÁî®ÂèëÂ∏É - ${{ env.VERSION }}
            
            ## üöÄ ÁâàÊú¨‰ø°ÊÅØ
            - **ÁâàÊú¨Âè∑**: ${{ env.VERSION }}
            - **Tag**: ${{ env.TAG_NAME }}
            - **ÊûÑÂª∫Êó∂Èó¥**: ${{ github.event.head_commit.timestamp }}
            - **Êèê‰∫§**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            
            ## üì¶ ÊûÑÂª∫‰∫ßÁâ©
            ‰∏ãÊñπÊèê‰æõ‰∫ÜÂ∑≤Á≠æÂêçÁöÑ HarmonyOS Â∫îÁî®Êñá‰ª∂ÔºåÂèØÁõ¥Êé•ÂÆâË£ÖÂà∞ HarmonyOS ËÆæÂ§á„ÄÇ
            
            ### Êñá‰ª∂‰ø°ÊÅØ
            - **‰∏ãËΩΩÊñá‰ª∂Âêç**: ${{ env.ARTIFACT_FILENAME }}
            - **ÂéüÂßãÁ±ªÂûã**: ${{ env.FILE_TYPE == 'app' && 'APP Êñá‰ª∂' || 'HAP Êñá‰ª∂' }}
            - **‰∏ä‰º†Ê†ºÂºè**: ${{ contains(env.ARTIFACT_FILENAME, '.zip') && 'ZIP ÂéãÁº©ÂåÖ' || 'HAP Êñá‰ª∂' }}
            
            ## üì± ÂÆâË£ÖËØ¥Êòé
            
            ### ÂØπ‰∫é APP Êñá‰ª∂Ôºà.zip Ê†ºÂºèÔºâ:
            1. ‰∏ãËΩΩ **${{ env.ARTIFACT_FILENAME }}** Êñá‰ª∂
            2. Ëß£Âéã ZIP Êñá‰ª∂ÔºåËé∑Âèñ **${{ env.ORIGINAL_FILENAME }}**
            3. Â∞ÜËß£ÂéãÂêéÁöÑÊñá‰ª∂‰º†ËæìÂà∞ HarmonyOS ËÆæÂ§á
            4. ‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§ÂÆâË£ÖÔºö
            ```bash
            hdc install ${{ env.ORIGINAL_FILENAME }}
            ```
            
            ### ÂØπ‰∫é HAP Êñá‰ª∂:
            1. ‰∏ãËΩΩ **${{ env.ARTIFACT_FILENAME }}** Êñá‰ª∂
            2. Â∞ÜÊñá‰ª∂‰º†ËæìÂà∞ HarmonyOS ËÆæÂ§á
            3. ‰ΩøÁî®‰ª•‰∏ãÂëΩ‰ª§ÂÆâË£ÖÔºö
            ```bash
            hdc install ${{ env.ARTIFACT_FILENAME }}
            ```
            
            4. ÊàñÂú®ËÆæÂ§áÊñá‰ª∂ÁÆ°ÁêÜÂô®‰∏≠Áõ¥Êé•ÁÇπÂáªÂÆâË£Ö
            
            ## üîß ÊûÑÂª∫‰ø°ÊÅØ
            - ÊûÑÂª∫Á≥ªÁªü: GitHub Actions
            - ÊûÑÂª∫ÁéØÂ¢É: Ubuntu Linux
            - HarmonyOS SDK: 6.0.2.640
            - ÊûÑÂª∫Â∑•ÂÖ∑: hvigorw assembleApp
            
            ---
            
            *Ê≠§ Release Áî± GitHub Actions Ëá™Âä®ÊûÑÂª∫ÂíåÂèëÂ∏É*
          
          # ‰ΩøÁî®Áé∞ÊúâÁöÑ tag
          tag_name: ${{ env.TAG_NAME }}
          
          # ÊòØÂê¶‰∏∫ËçâÁ®ø
          draft: false
          
          # ÊòØÂê¶‰∏∫È¢ÑÂèëÂ∏É
          prerelease: ${{ contains(env.TAG_NAME, 'beta') || contains(env.TAG_NAME, 'alpha') || contains(env.TAG_NAME, 'rc') || contains(env.TAG_NAME, 'preview') }}
          
          # ÁîüÊàêÂèëÂ∏ÉËØ¥Êòé
          generate_release_notes: true
          
          # ‰∏ä‰º†Êñá‰ª∂
          files: |
            ${{ env.ARTIFACT_FILE }}
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 15. ÊûÑÂª∫ÂÆåÊàêÈÄöÁü•
      - name: Build Complete
        run: |
          echo "üéâ HarmonyOS Â∫îÁî®ÊûÑÂª∫ÂíåÂèëÂ∏ÉÂÆåÊàêÔºÅ"
          echo ""
          echo "üìã ÂèëÂ∏É‰ø°ÊÅØ:"
          echo "  - ÁâàÊú¨: ${{ env.VERSION }}"
          echo "  - Tag: ${{ env.TAG_NAME }}"
          echo "  - Release: ${{ steps.create_release.outputs.html_url }}"
          echo "  - ÊûÑÂª∫‰∫ßÁâ©: ${{ env.ARTIFACT_FILENAME }}"
          echo "  - ÂéüÂßãÊñá‰ª∂: ${{ env.ORIGINAL_FILENAME }}"
          echo ""
          
          # ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
          if [ -f "${{ env.ARTIFACT_FILE }}" ]; then
            size=$(du -h "${{ env.ARTIFACT_FILE }}" | cut -f1)
            sha=$(sha256sum "${{ env.ARTIFACT_FILE }}" | cut -d' ' -f1)
            echo "üì¶ Êñá‰ª∂ËØ¶ÊÉÖ:"
            echo "  - ‰∏ä‰º†Êñá‰ª∂Âêç: ${{ env.ARTIFACT_FILENAME }}"
            echo "  - ÂéüÂßãÊñá‰ª∂Âêç: ${{ env.ORIGINAL_FILENAME }}"
            echo "  - Êñá‰ª∂Á±ªÂûã: ${{ env.FILE_TYPE == 'app' && 'APP (ÊâìÂåÖ‰∏∫ZIP)' || 'HAP' }}"
            echo "  - Â§ßÂ∞è: $size"
            echo "  - SHA256: $sha"
            
            # Â¶ÇÊûúÊòØ ZIP Êñá‰ª∂ÔºåÊòæÁ§∫Ëß£ÂéãËØ¥Êòé
            if [[ "${{ env.ARTIFACT_FILENAME }}" == *.zip ]]; then
              echo ""
              echo "üìù ‰ΩøÁî®ËØ¥Êòé:"
              echo "  1. ‰∏ãËΩΩ ${{ env.ARTIFACT_FILENAME }}"
              echo "  2. Ëß£ÂéãËé∑Âèñ ${{ env.ORIGINAL_FILENAME }}"
              echo "  3. ‰ΩøÁî® hdc install ${{ env.ORIGINAL_FILENAME }} ÂÆâË£Ö"
            fi
          fi
