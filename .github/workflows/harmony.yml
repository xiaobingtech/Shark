name: HarmonyOS Release Build Deploy to AppGallery

on:
  push:
    tags:
      - 'v*'  # åªå¯¹ v å¼€å¤´çš„ tag è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest  # ä½¿ç”¨ Ubuntu Linux ç¯å¢ƒ
    # runs-on: self-hosted
    
    # ä¸º Release æ·»åŠ ç­–ç•¥
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release
      actions: read
      checks: read

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…å«ç­¾åæ–‡ä»¶å’Œ tag ä¿¡æ¯ï¼‰
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç¡®ä¿æ‰€æœ‰æ–‡ä»¶
          ref: ${{ github.ref }}

      # 2. è·å– tag ä¿¡æ¯å¹¶è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Setup Tag Information
        run: |
          # è·å– tag åç§°ï¼ˆå»æ‰ refs/tags/ å‰ç¼€ï¼‰
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # è®¾ç½® Release åç§°ï¼ˆä½¿ç”¨ tag åç§°ï¼‰
          echo "RELEASE_NAME=$TAG_NAME" >> $GITHUB_ENV
          
          # ä» tag åç§°æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION=${TAG_NAME#v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "Tag: $TAG_NAME"
          echo "Version: $VERSION"
          echo "Release Name: $RELEASE_NAME"

      - name: Inject GitHub Run Id
        run: |
          RUN_ID=${{ github.run_id }}
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^  public static readonly GITHUB_RUN_ID: string = '.*';/  public static readonly GITHUB_RUN_ID: string = '$RUN_ID';/" common/src/main/ets/constant/CommonConstants.ets
          else
            sed -i "s/^  public static readonly GITHUB_RUN_ID: string = '.*';/  public static readonly GITHUB_RUN_ID: string = '$RUN_ID';/" common/src/main/ets/constant/CommonConstants.ets
          fi

      # 3. è®¾ç½®ç¯å¢ƒå˜é‡
      - name: Set Environment Variables
        run: |
          echo "JAVA_HOME=/opt/jdk-17" >> $GITHUB_ENV
          echo "COMMANDLINE_TOOL_DIR=/opt" >> $GITHUB_ENV
          echo "PROJECT_PATH=${{ github.workspace }}" >> $GITHUB_ENV
          echo "SIGNING_KEY_ALIAS=${{ secrets.SIGNING_KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          
          # è®¾ç½® DevEco SDK è·¯å¾„
          echo "DEVECO_SDK_HOME=/opt/command-line-tools/sdk" >> $GITHUB_ENV

      # 4. å®‰è£… JDK 17
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 5. ä¸‹è½½å¹¶åˆå¹¶å‘½ä»¤è¡Œå·¥å…·åˆ†å·åŒ…ï¼ˆä»… Linuxï¼ŒMac æœ¬åœ°å·²å®‰è£…ï¼‰
      - name: Download Commandline Tools (Split Archives)
        if: runner.os == 'Linux'
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/cli-tools
          cd /tmp/cli-tools
          
          # åˆ†å·æ–‡ä»¶çš„åŸºç¡€ URL
          BASE_URL="https://raw.githubusercontent.com/xiaobingtech/commandline-tools-linux-x64-6.0.2.640/refs/heads/main"
          
          echo "å¼€å§‹ä¸‹è½½å‘½ä»¤è¡Œå·¥å…·åˆ†å·åŒ…..."
          
          # ä¸‹è½½æ‰€æœ‰åˆ†å·æ–‡ä»¶ï¼ˆ001 åˆ° 019ï¼‰
          for i in {001..019}; do
            FILENAME="commandline-tools-linux-x64-6.0.2.640.7z.$i"
            URL="$BASE_URL/$FILENAME"
            echo "ä¸‹è½½: $FILENAME"
            
            # ä½¿ç”¨é‡è¯•æœºåˆ¶ä¸‹è½½
            for attempt in {1..3}; do
              echo "ä¸‹è½½å°è¯• $attempt..."
              if wget -q --timeout=30 "$URL" -O "$FILENAME"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ: $FILENAME ($(du -h "$FILENAME" | cut -f1))"
                break
              else
                echo "âŒ ä¸‹è½½å¤±è´¥ $attempt: $FILENAME"
                if [ $attempt -eq 3 ]; then
                  echo "âŒ ä¸‹è½½å¤±è´¥: $FILENAMEï¼Œç»ˆæ­¢æ„å»º"
                  exit 1
                fi
                sleep 3
              fi
            done
          done
          
          echo "æ‰€æœ‰åˆ†å·ä¸‹è½½å®Œæˆ"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -lh *.7z.*
          
          # éªŒè¯æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(ls -1 *.7z.* 2>/dev/null | wc -l)
          echo "æ‰¾åˆ° $FILE_COUNT ä¸ªåˆ†å·æ–‡ä»¶"
          
          if [ "$FILE_COUNT" -ne 19 ]; then
            echo "âŒ é”™è¯¯: æœŸæœ› 19 ä¸ªåˆ†å·æ–‡ä»¶ï¼Œä½†æ‰¾åˆ° $FILE_COUNT ä¸ª"
            exit 1
          fi
          
          # åˆå¹¶æ–‡ä»¶
          echo "åˆå¹¶åˆ†å·æ–‡ä»¶..."
          COMBINED_FILE="commandline-tools-linux-x64-6.0.2.640.7z"
          cat commandline-tools-linux-x64-6.0.2.640.7z.* > "$COMBINED_FILE"
          
          # éªŒè¯åˆå¹¶åçš„æ–‡ä»¶
          if [ -f "$COMBINED_FILE" ]; then
            COMBINED_SIZE=$(du -h "$COMBINED_FILE" | cut -f1)
            echo "âœ… åˆå¹¶æˆåŠŸ: $COMBINED_FILE ($COMBINED_SIZE)"
          else
            echo "âŒ åˆå¹¶å¤±è´¥"
            exit 1
          fi
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          sudo mkdir -p /opt/command-line-tools
          sudo chown -R runner:runner /opt/command-line-tools
          
          echo "è§£å‹ 7z æ–‡ä»¶..."
          
          # å®‰è£…è§£å‹å·¥å…·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if ! command -v 7z &> /dev/null; then
            echo "å®‰è£… p7zip å·¥å…·..."
            sudo apt-get update
            sudo apt-get install -y p7zip-full
          fi
          
          if ! command -v unzip &> /dev/null; then
            echo "å®‰è£… unzip å·¥å…·..."
            sudo apt-get install -y unzip
          fi
          
          # å…ˆåˆ—å‡º7zæ–‡ä»¶å†…å®¹ï¼ŒæŸ¥çœ‹å†…éƒ¨ç»“æ„
          echo "åˆ—å‡º7zæ–‡ä»¶å†…å®¹..."
          7z l "$COMBINED_FILE" | head -20
          
          # åˆ›å»ºè§£å‹ç›®å½•
          mkdir -p extract
          
          echo "ç¬¬ä¸€æ­¥ï¼šè§£å‹ 7z æ–‡ä»¶..."
          # è§£å‹7zæ–‡ä»¶
          7z x "$COMBINED_FILE" -oextract -y
          
          if [ $? -eq 0 ]; then
            echo "âœ… 7z è§£å‹æˆåŠŸ"
            
            # æŸ¥çœ‹è§£å‹å‡ºçš„æ–‡ä»¶
            echo "è§£å‹å‡ºçš„æ–‡ä»¶:"
            ls -la extract/
            
            # æŸ¥æ‰¾ zip æ–‡ä»¶
            ZIP_FILE=$(find extract -name "*.zip" -type f | head -1)
            if [ -n "$ZIP_FILE" ]; then
              echo "æ‰¾åˆ° ZIP æ–‡ä»¶: $ZIP_FILE"
              
              echo "ç¬¬äºŒæ­¥ï¼šè§£å‹ ZIP æ–‡ä»¶åˆ° /opt/command-line-tools..."
              # è§£å‹ zip æ–‡ä»¶
              unzip "$ZIP_FILE" -d /opt/command-line-tools
              
              if [ $? -eq 0 ]; then
                echo "âœ… ZIP è§£å‹æˆåŠŸ"
                
                # æ£€æŸ¥è§£å‹ç»“æœ
                echo "æ£€æŸ¥è§£å‹ç›®å½•å†…å®¹..."
                find /opt/command-line-tools -maxdepth 2 -type f | head -10
                
                # è®¡ç®—æ–‡ä»¶æ•°é‡
                FILE_COUNT=$(find /opt/command-line-tools -type f 2>/dev/null | wc -l)
                echo "è§£å‹å‡º $FILE_COUNT ä¸ªæ–‡ä»¶"
                
                # æ£€æŸ¥å…³é”®å·¥å…·
                echo "æŸ¥æ‰¾å…³é”®å·¥å…·:"
                for tool in hvigorw ohpm hdc hap-sign-tool.jar; do
                  TOOL_PATH=$(find /opt/command-line-tools -name "$tool" -type f 2>/dev/null | head -1)
                  if [ -n "$TOOL_PATH" ]; then
                    echo "âœ… æ‰¾åˆ° $tool: $TOOL_PATH"
                  else
                    echo "âš ï¸ æœªæ‰¾åˆ° $tool"
                  fi
                done
                
                # æ£€æŸ¥æ˜¯å¦æœ‰åµŒå¥—çš„ç›®å½•ç»“æ„ï¼Œå¦‚æœæœ‰åˆ™è°ƒæ•´
                if [ -d "/opt/command-line-tools/command-line-tools" ]; then
                  echo "å‘ç°åµŒå¥—ç›®å½•ç»“æ„ï¼Œæ­£åœ¨è°ƒæ•´..."
                  mv /opt/command-line-tools/command-line-tools/* /opt/command-line-tools/
                  rm -rf /opt/command-line-tools/command-line-tools
                fi
                
              else
                echo "âŒ ZIP è§£å‹å¤±è´¥"
                exit 1
              fi
            else
              # å¦‚æœæ²¡æœ‰æ‰¾åˆ° zip æ–‡ä»¶ï¼Œå°è¯•å…¶ä»–æ ¼å¼
              echo "æœªæ‰¾åˆ° ZIP æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å…¶ä»–æ ¼å¼..."
              ALL_FILES=$(find extract -type f)
              echo "æ‰€æœ‰è§£å‹æ–‡ä»¶:"
              echo "$ALL_FILES"
              
              # å°è¯•ç›´æ¥ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶
              mv extract/* /opt/command-line-tools/ 2>/dev/null || true
              
              FILE_COUNT=$(find /opt/command-line-tools -type f 2>/dev/null | wc -l)
              echo "ç§»åŠ¨äº† $FILE_COUNT ä¸ªæ–‡ä»¶åˆ° /opt/command-line-tools"
            fi
          else
            echo "âŒ 7z è§£å‹å¤±è´¥"
            exit 1
          fi
          
          # è®¾ç½®ç›®å½•æƒé™
          sudo chmod -R 755 /opt/command-line-tools
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          cd /
          rm -rf /tmp/cli-tools
          echo "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"

      # 6. æ ¹æ®å®é™…ä½ç½®é…ç½®ç¯å¢ƒå˜é‡
      - name: Configure Environment
        run: |
          # æŸ¥æ‰¾å·¥å…·çš„å®é™…ä½ç½®
          HVIGORW_PATH=$(find /opt -name "hvigorw" -type f 2>/dev/null | head -1)
          OHPM_PATH=$(find /opt -name "ohpm" -type f 2>/dev/null | head -1)
          HDC_PATH=$(find /opt -name "hdc" -type f 2>/dev/null | head -1)
          
          # æå–ç›®å½•è·¯å¾„å¹¶æ·»åŠ åˆ° PATH
          if [ -n "$HVIGORW_PATH" ]; then
            HVIGORW_DIR=$(dirname "$HVIGORW_PATH")
            echo "$HVIGORW_DIR" >> $GITHUB_PATH
          fi
          
          if [ -n "$OHPM_PATH" ]; then
            OHPM_DIR=$(dirname "$OHPM_PATH")
            echo "$OHPM_DIR" >> $GITHUB_PATH
          fi
          
          if [ -n "$HDC_PATH" ]; then
            HDC_DIR=$(dirname "$HDC_PATH")
            echo "$HDC_DIR" >> $GITHUB_PATH
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é€šç”¨çš„ bin ç›®å½•
          BIN_DIRS=$(find /opt/command-line-tools -name "bin" -type d 2>/dev/null)
          for dir in $BIN_DIRS; do
            echo "$dir" >> $GITHUB_PATH
          done
          
          # è®¾ç½® DEVECO_SDK_HOME åˆ° PATH
          echo "/opt/command-line-tools/sdk" >> $GITHUB_PATH

      # 7. åˆ›å»ºç¬¦å·é“¾æ¥
      - name: Create Symbolic Links
        run: |
          # ä¸ºå·¥å…·åˆ›å»ºç¬¦å·é“¾æ¥åˆ° /usr/local/bin
          for tool in hvigorw ohpm hdc; do
            TOOL_PATH=$(find /opt -name "$tool" -type f 2>/dev/null | head -1)
            if [ -n "$TOOL_PATH" ]; then
              sudo ln -sf "$TOOL_PATH" /usr/local/bin/
            fi
          done

      # 8. é…ç½® npm å’Œ ohpm é•œåƒ
      - name: Configure Registries
        run: |
          npm config set registry https://repo.huaweicloud.com/repository/npm/
          npm config set "@ohos:registry" https://repo.harmonyos.com/npm/
          
          if command -v ohpm &> /dev/null; then
            ohpm config set registry https://ohpm.openharmony.cn/ohpm/
            ohpm config set strict_ssl false
          fi

      # 9. å®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev

      # 10. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install Dependencies
        run: |
          cd ${{ env.PROJECT_PATH }}
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡
          export DEVECO_SDK_HOME=/opt/command-line-tools/sdk
          
          # å®‰è£… npm ä¾èµ–
          if [ -f "package.json" ]; then
            npm install
          fi
          
          # å®‰è£… ohpm ä¾èµ–
          if [ -f "oh-package.json5" ] || [ -f "oh-package.json" ]; then
            if command -v ohpm &> /dev/null; then
              ohpm install --all
            fi
          fi

      # 11. æ„å»º release APP
      - name: Build Release APP
        run: |
          cd ${{ env.PROJECT_PATH }}
          echo "å¼€å§‹æ„å»º release APP..."
          echo "ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "Tag: ${{ env.TAG_NAME }}"
          
          # ç¡®ä¿ç¯å¢ƒå˜é‡å·²è®¾ç½®
          export DEVECO_SDK_HOME=/opt/command-line-tools/sdk
          
          # å…ˆæ¸…ç†
          hvigorw clean --no-daemon
          
          # æ„å»º APP
          hvigorw assembleApp --mode project -p product=default --no-daemon
          echo "Release APP æ„å»ºå®Œæˆ"
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©
          echo "=== æ„å»ºäº§ç‰© ==="
          find . -name "*.app" -type f 2>/dev/null
          find . -name "*.hap" -type f 2>/dev/null

      # 12. ç­¾å release APP
      - name: Sign Release APP
        run: |
          cd ${{ env.PROJECT_PATH }}
          
          echo "å¼€å§‹ç­¾å release APP..."
          
          # æŸ¥æ‰¾æœªç­¾åçš„ APP æ–‡ä»¶ï¼ˆ.app æ–‡ä»¶ï¼‰
          UNSIGNED_APP=$(find . -name "*release-unsigned.app" -type f | head -1)
          if [ -z "$UNSIGNED_APP" ]; then
            echo "æœªæ‰¾åˆ° release æœªç­¾åçš„ APP æ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–..."
            UNSIGNED_APP=$(find . -name "*-unsigned.app" -type f | head -1)
          fi
          
          # å¦‚æœæ‰¾ä¸åˆ°æœªç­¾åçš„ APPï¼Œå°è¯•æŸ¥æ‰¾æœªç­¾åçš„ HAP
          if [ -z "$UNSIGNED_APP" ]; then
            echo "æœªæ‰¾åˆ°æœªç­¾åçš„ APP æ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾æœªç­¾åçš„ HAP æ–‡ä»¶..."
            UNSIGNED_HAP=$(find . -name "*release-unsigned.hap" -type f | head -1)
            if [ -z "$UNSIGNED_HAP" ]; then
              UNSIGNED_HAP=$(find . -name "*-unsigned.hap" -type f | head -1)
            fi
            
            if [ -n "$UNSIGNED_HAP" ]; then
              echo "æ‰¾åˆ°æœªç­¾åçš„ HAP: $UNSIGNED_HAP"
              UNSIGNED_APP="$UNSIGNED_HAP"
            fi
          fi
          
          if [ -z "$UNSIGNED_APP" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•æœªç­¾åçš„æ„å»ºäº§ç‰©"
            echo "æœç´¢åˆ°çš„æ–‡ä»¶:"
            find . -name "*.app" -type f 2>/dev/null
            find . -name "*.hap" -type f 2>/dev/null
            exit 1
          fi
          
          echo "æ‰¾åˆ°æœªç­¾åçš„æ–‡ä»¶: $UNSIGNED_APP"
          
          # æ ¹æ®æ–‡ä»¶ç±»å‹ç¡®å®šæ‰©å±•å
          if [[ "$UNSIGNED_APP" == *.app ]]; then
            EXTENSION=".app"
            BASENAME=$(basename "$UNSIGNED_APP" "-unsigned.app")
            OUTPUT_EXTENSION=".app"
          else
            EXTENSION=".hap"
            BASENAME=$(basename "$UNSIGNED_APP" "-unsigned.hap")
            OUTPUT_EXTENSION=".hap"
          fi
          
          # ç”Ÿæˆç­¾ååçš„æ–‡ä»¶åï¼ˆæ·»åŠ ç‰ˆæœ¬å·ï¼‰
          SIGNED_FILE="build/${BASENAME}-v${{ env.VERSION }}-signed${OUTPUT_EXTENSION}"
          
          # ç¡®ä¿ build ç›®å½•å­˜åœ¨
          mkdir -p build
          
          # æŸ¥æ‰¾ç­¾åå·¥å…·
          SIGN_TOOL=$(find /opt -name "hap-sign-tool.jar" -type f 2>/dev/null | head -1)
          
          echo "ä½¿ç”¨ç­¾åå·¥å…·: $SIGN_TOOL"
          echo "è¾“å…¥æ–‡ä»¶: $UNSIGNED_APP"
          echo "è¾“å‡ºæ–‡ä»¶: $SIGNED_FILE"
          echo "æ–‡ä»¶ç±»å‹: ${EXTENSION:1}"  # å»æ‰ç‚¹çš„æ‰©å±•å
          
          # æ‰§è¡Œç­¾å
          java -jar "$SIGN_TOOL" \
            sign-app \
            -keyAlias "${{ env.SIGNING_KEY_ALIAS }}" \
            -signAlg "SHA256withECDSA" \
            -mode "localSign" \
            -appCertFile "./dis.cer" \
            -profileFile "./disRelease.p7b" \
            -inFile "$UNSIGNED_APP" \
            -keystoreFile "./dis.p12" \
            -outFile "$SIGNED_FILE" \
            -keyPwd "${{ env.KEYSTORE_PASSWORD }}" \
            -keystorePwd "${{ env.KEYSTORE_PASSWORD }}"
          
          if [ -f "$SIGNED_FILE" ]; then
            echo "ç­¾åæˆåŠŸ: $SIGNED_FILE ($(du -h "$SIGNED_FILE" | cut -f1))"
          else
            echo "é”™è¯¯ï¼šç­¾åå¤±è´¥"
            exit 1
          fi

      # 13. å¤„ç†æ„å»ºäº§ç‰©ä»¥ä¾¿ä¸Šä¼ åˆ° GitHub Release
      - name: Prepare Artifacts for Release
        run: |
          cd ${{ env.PROJECT_PATH }}
          echo "=== å¤„ç†æ„å»ºäº§ç‰©ä»¥ä¾¿ä¸Šä¼ åˆ° GitHub Release ==="
          
          # æŸ¥æ‰¾æ‰€æœ‰ç­¾åæ–‡ä»¶ï¼ˆAPP å’Œ HAPï¼‰
          echo "æœç´¢ç­¾åæ–‡ä»¶..."
          SIGNED_APP=$(find . -name "*-v${{ env.VERSION }}-signed.app" -type f 2>/dev/null | head -1)
          SIGNED_HAP=$(find . -name "*-v${{ env.VERSION }}-signed.hap" -type f 2>/dev/null | head -1)
          
          # ä¼˜å…ˆä½¿ç”¨ APP æ–‡ä»¶
          if [ -n "$SIGNED_APP" ]; then
            PRIMARY_FILE="$SIGNED_APP"
            ORIGINAL_EXTENSION=".app"
            echo "æ‰¾åˆ° APP æ–‡ä»¶: $PRIMARY_FILE"
          elif [ -n "$SIGNED_HAP" ]; then
            PRIMARY_FILE="$SIGNED_HAP"
            ORIGINAL_EXTENSION=".hap"
            echo "æ‰¾åˆ° HAP æ–‡ä»¶: $PRIMARY_FILE"
          else
            # å¦‚æœæ²¡æœ‰å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç­¾åæ–‡ä»¶
            PRIMARY_FILE=$(find . -name "*-signed.app" -type f 2>/dev/null | head -1)
            if [ -n "$PRIMARY_FILE" ]; then
              ORIGINAL_EXTENSION=".app"
            else
              PRIMARY_FILE=$(find . -name "*-signed.hap" -type f 2>/dev/null | head -1)
              ORIGINAL_EXTENSION=".hap"
            fi
          fi
          
          if [ -z "$PRIMARY_FILE" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°å·²ç­¾åçš„æ„å»ºäº§ç‰©"
            exit 1
          fi
          
          echo "åŸå§‹æ–‡ä»¶: $PRIMARY_FILE"
          
          # è·å–åŸå§‹æ–‡ä»¶åï¼ˆä¸å¸¦è·¯å¾„ï¼‰
          ORIGINAL_FILENAME=$(basename "$PRIMARY_FILE")
          
          # åä¸º AppGallery ä¸Šä¼ ä½¿ç”¨åŸå§‹æ–‡ä»¶ï¼ˆ.app æˆ– .hapï¼‰
          HUAWEI_UPLOAD_FILE="./$ORIGINAL_FILENAME"
          cp "$PRIMARY_FILE" "$HUAWEI_UPLOAD_FILE"
          echo "åä¸ºä¸Šä¼ æ–‡ä»¶: $HUAWEI_UPLOAD_FILE"
          
          # åˆ›å»ºæ–°çš„æ–‡ä»¶åç”¨äº GitHub Releaseï¼ˆå°† .app æ”¹ä¸º .zipï¼Œ.hap ä¿æŒä¸å˜ï¼‰
          if [[ "$ORIGINAL_EXTENSION" == ".app" ]]; then
            # å¯¹äº .app æ–‡ä»¶ï¼Œæ”¹ä¸º .zip æ‰©å±•åä»¥ä¾¿ GitHub æ¥å—
            UPLOAD_FILENAME="${ORIGINAL_FILENAME%.app}.zip"
            UPLOAD_EXTENSION=".zip"
            FILE_TYPE="app"
          else
            # å¯¹äº .hap æ–‡ä»¶ï¼Œä¿æŒåŸæ ·
            UPLOAD_FILENAME="$ORIGINAL_FILENAME"
            UPLOAD_EXTENSION=".hap"
            FILE_TYPE="hap"
          fi
          
          # å¤åˆ¶æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼Œå¹¶æ ¹æ®éœ€è¦é‡å‘½å
          if [[ "$ORIGINAL_EXTENSION" == ".app" ]]; then
            # å¯¹äº .app æ–‡ä»¶ï¼Œåˆ›å»º zip æ–‡ä»¶
            echo "åˆ›å»º ZIP æ–‡ä»¶ä»¥ä¾¿ä¸Šä¼ åˆ° GitHub Release..."
            zip -j "./$UPLOAD_FILENAME" "$PRIMARY_FILE"
            FINAL_FILE_PATH="./$UPLOAD_FILENAME"
          else
            # å¯¹äº .hap æ–‡ä»¶ï¼Œç›´æ¥å¤åˆ¶
            cp "$PRIMARY_FILE" "./$UPLOAD_FILENAME"
            FINAL_FILE_PATH="./$UPLOAD_FILENAME"
          fi
          
          echo "æœ€ç»ˆä¸Šä¼ æ–‡ä»¶: $FINAL_FILE_PATH"
          echo "ä¸Šä¼ æ–‡ä»¶å: $UPLOAD_FILENAME"
          echo "åŸå§‹ç±»å‹: ${ORIGINAL_EXTENSION:1}"
          echo "ä¸Šä¼ ç±»å‹: ${UPLOAD_EXTENSION:1}"
          
          # å°†æ–‡ä»¶ä¿¡æ¯ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "ARTIFACT_FILE=$FINAL_FILE_PATH" >> $GITHUB_ENV
          echo "ARTIFACT_FILENAME=$UPLOAD_FILENAME" >> $GITHUB_ENV
          echo "ORIGINAL_FILENAME=$ORIGINAL_FILENAME" >> $GITHUB_ENV
          echo "FILE_TYPE=$FILE_TYPE" >> $GITHUB_ENV
          echo "ORIGINAL_EXTENSION=$ORIGINAL_EXTENSION" >> $GITHUB_ENV
          # åä¸ºä¸Šä¼ ä½¿ç”¨åŸå§‹æ ¼å¼çš„æ–‡ä»¶
          echo "HUAWEI_UPLOAD_FILE=$HUAWEI_UPLOAD_FILE" >> $GITHUB_ENV
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          if [ -f "$FINAL_FILE_PATH" ]; then
            size=$(du -h "$FINAL_FILE_PATH" | cut -f1)
            echo "âœ… å‡†å¤‡ä¸Šä¼ : $UPLOAD_FILENAME (${UPLOAD_EXTENSION:1}, $size)"
            
            # å¦‚æœæ˜¯ ZIP æ–‡ä»¶ï¼Œæ˜¾ç¤ºå†…å®¹ä¿¡æ¯
            if [[ "$UPLOAD_EXTENSION" == ".zip" ]]; then
              echo "ZIP æ–‡ä»¶å†…å®¹:"
              unzip -l "$FINAL_FILE_PATH" | head -5
            fi
          else
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨: $FINAL_FILE_PATH"
            exit 1
          fi

      - name: Upload to Huawei AppGallery
        env:
          HUAWEI_CLIENT_ID: ${{ secrets.HUAWEI_CLIENT_ID }}
          HUAWEI_CLIENT_SECRET: ${{ secrets.HUAWEI_CLIENT_SECRET }}
          HUAWEI_APP_ID: ${{ secrets.HUAWEI_APP_ID }}
          HUAWEI_RELEASE_TYPE: ${{ secrets.HUAWEI_RELEASE_TYPE || '1' }}
          HUAWEI_CHINA_MAINLAND_FLAG: ${{ secrets.HUAWEI_CHINA_MAINLAND_FLAG || '1' }}
          HUAWEI_UPLOAD_FILE: ${{ env.HUAWEI_UPLOAD_FILE }}
          ORIGINAL_FILENAME: ${{ env.ORIGINAL_FILENAME }}
        run: |
          set -e
          FILE_PATH="$HUAWEI_UPLOAD_FILE"
          FILE_NAME="$ORIGINAL_FILENAME"

          if [ -z "$HUAWEI_CLIENT_ID" ] || [ -z "$HUAWEI_CLIENT_SECRET" ] || [ -z "$HUAWEI_APP_ID" ]; then
            echo "âŒ ç¼ºå°‘åä¸ºä¸Šä¼ æ‰€éœ€å¯†é’¥"
            exit 1
          fi

          if [ ! -f "$FILE_PATH" ]; then
            echo "âŒ ä¸Šä¼ æ–‡ä»¶ä¸å­˜åœ¨: $FILE_PATH"
            exit 1
          fi

          FILE_SIZE=$(stat -c%s "$FILE_PATH")
          SHA256=$(sha256sum "$FILE_PATH" | cut -d' ' -f1)
          echo "ğŸ“¦ å¾…ä¸Šä¼ : $FILE_NAME ($(du -h "$FILE_PATH" | cut -f1), SHA256: ${SHA256:0:16}...)"

          # â”€â”€ Step 1: è·å– Access Token â”€â”€
          echo "ğŸ“¤ è·å– Access Token..."
          TOKEN_RESP=$(curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"grant_type\":\"client_credentials\",\"client_id\":\"${HUAWEI_CLIENT_ID}\",\"client_secret\":\"${HUAWEI_CLIENT_SECRET}\"}" \
            "https://connect-api.cloud.huawei.com/api/oauth2/v1/token")

          if ! echo "$TOKEN_RESP" | jq empty 2>/dev/null; then
            echo "âŒ Token API è¿”å›é JSON å“åº”"
            exit 1
          fi

          ACCESS_TOKEN=$(echo "$TOKEN_RESP" | jq -r '.access_token // empty')
          if [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ è·å– access_token å¤±è´¥"
            exit 1
          fi
          echo "âœ… Access Token è·å–æˆåŠŸ"

          # â”€â”€ Step 2: è·å–ä¸Šä¼ æ–‡ä»¶åœ°å€ â”€â”€
          echo "ğŸ“¤ è·å–ä¸Šä¼ åœ°å€..."
          FILE_NAME_ENC=$(jq -Rr @uri <<< "$FILE_NAME")
          UPLOAD_GET_URL="https://connect-api.cloud.huawei.com/api/publish/v2/upload-url/for-obs?appId=${HUAWEI_APP_ID}&fileName=${FILE_NAME_ENC}&contentLength=${FILE_SIZE}"
          echo "ğŸ”— è¯·æ±‚URL: $UPLOAD_GET_URL"
          UPLOAD_URL_RESP=$(curl -sS -w "\n%{http_code}" \
            -H "Authorization: Bearer ${ACCESS_TOKEN}" \
            -H "Host: connect-api.cloud.huawei.com" \
            -H "client_id: ${HUAWEI_CLIENT_ID}" \
            -H "Content-Type: application/json" \
            "$UPLOAD_GET_URL")

          HTTP_CODE=$(echo "$UPLOAD_URL_RESP" | tail -n1)
          RESP_BODY=$(echo "$UPLOAD_URL_RESP" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ è·å–ä¸Šä¼ åœ°å€å¤±è´¥ (HTTP $HTTP_CODE)"
            if [ -n "$RESP_BODY" ]; then
              ERR_CODE=$(echo "$RESP_BODY" | jq -r '.ret.code // empty' 2>/dev/null)
              ERR_MSG=$(echo "$RESP_BODY" | jq -r '.ret.msg // empty' 2>/dev/null)
              if [ -n "$ERR_CODE" ]; then
                echo "é”™è¯¯ç : $ERR_CODE, ä¿¡æ¯: $ERR_MSG"
              else
                echo "$RESP_BODY" | jq . 2>/dev/null || echo "$RESP_BODY"
              fi
            fi
            exit 1
          fi

          UPLOAD_URL=$(echo "$RESP_BODY" | jq -r '.urlInfo.url // empty')
          UPLOAD_HDR_AUTH=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers.Authorization // empty')
          UPLOAD_HDR_SHA256=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."x-amz-content-sha256" // empty')
          UPLOAD_HDR_DATE=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."x-amz-date" // empty')
          UPLOAD_HDR_HOST=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers.Host // empty')
          UPLOAD_HDR_UA=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."user-agent" // empty')
          UPLOAD_HDR_CT=$(echo "$RESP_BODY" | jq -r '.urlInfo.headers."Content-Type" // "application/octet-stream"')

          if [ -z "$UPLOAD_URL" ]; then
            echo "âŒ è·å–ä¸Šä¼ åœ°å€å¤±è´¥: urlInfo.url ä¸ºç©º"
            exit 1
          fi
          echo "âœ… ä¸Šä¼ åœ°å€è·å–æˆåŠŸ"

          # â”€â”€ Step 3: ä¸Šä¼ æ–‡ä»¶ (PUT to OBS) â”€â”€
          echo "ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ°åä¸º OBS..."
          CURL_ARGS=(-sS -w "\n%{http_code}" -X PUT --upload-file "$FILE_PATH")
          [ -n "$UPLOAD_HDR_AUTH" ]   && CURL_ARGS+=(-H "Authorization: $UPLOAD_HDR_AUTH")
          [ -n "$UPLOAD_HDR_SHA256" ] && CURL_ARGS+=(-H "x-amz-content-sha256: $UPLOAD_HDR_SHA256")
          [ -n "$UPLOAD_HDR_DATE" ]   && CURL_ARGS+=(-H "x-amz-date: $UPLOAD_HDR_DATE")
          [ -n "$UPLOAD_HDR_HOST" ]   && CURL_ARGS+=(-H "Host: $UPLOAD_HDR_HOST")
          [ -n "$UPLOAD_HDR_UA" ]     && CURL_ARGS+=(-H "user-agent: $UPLOAD_HDR_UA")
          [ -n "$UPLOAD_HDR_CT" ]     && CURL_ARGS+=(-H "Content-Type: $UPLOAD_HDR_CT")

          UPLOAD_RESP=$(curl "${CURL_ARGS[@]}" "$UPLOAD_URL")
          UPLOAD_HTTP_CODE=$(echo "$UPLOAD_RESP" | tail -n1)

          if [ "$UPLOAD_HTTP_CODE" -eq 200 ]; then
            echo "âœ… åä¸º AppGallery ä¸Šä¼ æˆåŠŸï¼($FILE_NAME, $(du -h "$FILE_PATH" | cut -f1))"
          else
            UPLOAD_RESP_BODY=$(echo "$UPLOAD_RESP" | sed '$d')
            echo "âŒ ä¸Šä¼ å¤±è´¥ (HTTP $UPLOAD_HTTP_CODE)"
            echo "$UPLOAD_RESP_BODY"
            exit 1
          fi

      # 14. åˆ›å»º GitHub Release
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          # ä½¿ç”¨ tag åç§°ä½œä¸º Release åç§°
          name: ${{ env.RELEASE_NAME }}
          
          # Release è¯´æ˜
          body: |
            # HarmonyOS åº”ç”¨å‘å¸ƒ - ${{ env.VERSION }}
            
            ## ğŸš€ ç‰ˆæœ¬ä¿¡æ¯
            - **ç‰ˆæœ¬å·**: ${{ env.VERSION }}
            - **Tag**: ${{ env.TAG_NAME }}
            - **æ„å»ºæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            
            ## ğŸ“¦ æ„å»ºäº§ç‰©
            ä¸‹æ–¹æä¾›äº†å·²ç­¾åçš„ HarmonyOS åº”ç”¨æ–‡ä»¶ï¼Œå¯ç›´æ¥å®‰è£…åˆ° HarmonyOS è®¾å¤‡ã€‚
            
            ### æ–‡ä»¶ä¿¡æ¯
            - **ä¸‹è½½æ–‡ä»¶å**: ${{ env.ARTIFACT_FILENAME }}
            - **åŸå§‹ç±»å‹**: ${{ env.FILE_TYPE == 'app' && 'APP æ–‡ä»¶' || 'HAP æ–‡ä»¶' }}
            - **ä¸Šä¼ æ ¼å¼**: ${{ contains(env.ARTIFACT_FILENAME, '.zip') && 'ZIP å‹ç¼©åŒ…' || 'HAP æ–‡ä»¶' }}
            
            ## ğŸ“± å®‰è£…è¯´æ˜
            
            ### å¯¹äº APP æ–‡ä»¶ï¼ˆ.zip æ ¼å¼ï¼‰:
            1. ä¸‹è½½ **${{ env.ARTIFACT_FILENAME }}** æ–‡ä»¶
            2. è§£å‹ ZIP æ–‡ä»¶ï¼Œè·å– **${{ env.ORIGINAL_FILENAME }}**
            3. å°†è§£å‹åçš„æ–‡ä»¶ä¼ è¾“åˆ° HarmonyOS è®¾å¤‡
            4. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
            ```bash
            hdc install ${{ env.ORIGINAL_FILENAME }}
            ```
            
            ### å¯¹äº HAP æ–‡ä»¶:
            1. ä¸‹è½½ **${{ env.ARTIFACT_FILENAME }}** æ–‡ä»¶
            2. å°†æ–‡ä»¶ä¼ è¾“åˆ° HarmonyOS è®¾å¤‡
            3. ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
            ```bash
            hdc install ${{ env.ARTIFACT_FILENAME }}
            ```
            
            4. æˆ–åœ¨è®¾å¤‡æ–‡ä»¶ç®¡ç†å™¨ä¸­ç›´æ¥ç‚¹å‡»å®‰è£…
            
            ## ğŸ”§ æ„å»ºä¿¡æ¯
            - æ„å»ºç³»ç»Ÿ: GitHub Actions
            - æ„å»ºç¯å¢ƒ: Ubuntu Linux
            - HarmonyOS SDK: 6.0.2.640
            - æ„å»ºå·¥å…·: hvigorw assembleApp
            
            ---
            
            *æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ*
          
          # ä½¿ç”¨ç°æœ‰çš„ tag
          tag_name: ${{ env.TAG_NAME }}
          
          # æ˜¯å¦ä¸ºè‰ç¨¿
          draft: false
          
          # æ˜¯å¦ä¸ºé¢„å‘å¸ƒ
          prerelease: ${{ contains(env.TAG_NAME, 'beta') || contains(env.TAG_NAME, 'alpha') || contains(env.TAG_NAME, 'rc') || contains(env.TAG_NAME, 'preview') }}
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          generate_release_notes: true
          
          # ä¸Šä¼ æ–‡ä»¶
          files: |
            ${{ env.ARTIFACT_FILE }}
          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 15. æ„å»ºå®Œæˆé€šçŸ¥
      - name: Build Complete
        run: |
          echo "ğŸ‰ HarmonyOS åº”ç”¨æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
          echo ""
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
          echo "  - ç‰ˆæœ¬: ${{ env.VERSION }}"
          echo "  - Tag: ${{ env.TAG_NAME }}"
          echo "  - Release: ${{ steps.create_release.outputs.html_url }}"
          echo "  - æ„å»ºäº§ç‰©: ${{ env.ARTIFACT_FILENAME }}"
          echo "  - åŸå§‹æ–‡ä»¶: ${{ env.ORIGINAL_FILENAME }}"
          echo ""
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          if [ -f "${{ env.ARTIFACT_FILE }}" ]; then
            size=$(du -h "${{ env.ARTIFACT_FILE }}" | cut -f1)
            sha=$(sha256sum "${{ env.ARTIFACT_FILE }}" | cut -d' ' -f1)
            echo "ğŸ“¦ æ–‡ä»¶è¯¦æƒ…:"
            echo "  - ä¸Šä¼ æ–‡ä»¶å: ${{ env.ARTIFACT_FILENAME }}"
            echo "  - åŸå§‹æ–‡ä»¶å: ${{ env.ORIGINAL_FILENAME }}"
            echo "  - æ–‡ä»¶ç±»å‹: ${{ env.FILE_TYPE == 'app' && 'APP (æ‰“åŒ…ä¸ºZIP)' || 'HAP' }}"
            echo "  - å¤§å°: $size"
            echo "  - SHA256: $sha"
            
            # å¦‚æœæ˜¯ ZIP æ–‡ä»¶ï¼Œæ˜¾ç¤ºè§£å‹è¯´æ˜
            if [[ "${{ env.ARTIFACT_FILENAME }}" == *.zip ]]; then
              echo ""
              echo "ğŸ“ ä½¿ç”¨è¯´æ˜:"
              echo "  1. ä¸‹è½½ ${{ env.ARTIFACT_FILENAME }}"
              echo "  2. è§£å‹è·å– ${{ env.ORIGINAL_FILENAME }}"
              echo "  3. ä½¿ç”¨ hdc install ${{ env.ORIGINAL_FILENAME }} å®‰è£…"
            fi
          fi
